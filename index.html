<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Qu·∫£n l√Ω TTBYT</title>
    <!-- Th∆∞ vi·ªán Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Th∆∞ vi·ªán Bi·ªÉu ƒë·ªì & L·ªãch -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <!-- Th∆∞ vi·ªán t·∫°o m√£ QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <style>
        :root { 
            --primary-color: #0e7490; 
            --sidebar-width: 260px; 
            --bg-light: #f8fafc;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; font-size: 0.9rem; overflow-x: hidden; }
        
        /* Layout */
        #wrapper { display: flex; width: 100%; min-height: 100vh; }
        #sidebar { 
            min-width: var(--sidebar-width); 
            background: white; 
            border-right: 1px solid #e2e8f0; 
            position: fixed; 
            height: 100vh; 
            z-index: 1000; 
            transition: 0.3s;
            display: flex;
            flex-direction: column;
        }
        #content { 
            flex: 1; 
            margin-left: var(--sidebar-width); 
            padding: 20px; 
            transition: 0.3s; 
        }
        
        /* Sidebar Elements */
        .brand { padding: 20px; border-bottom: 1px solid #f1f5f9; }
        .nav-link { 
            color: #64748b; 
            padding: 12px 20px; 
            display: flex; 
            align-items: center; 
            font-weight: 500;
            border-left: 3px solid transparent;
            transition: 0.2s;
        }
        .nav-link:hover { background: #f8fafc; color: var(--primary-color); }
        .nav-link.active { background: #e0f2fe; color: var(--primary-color); border-left-color: var(--primary-color); }
        .nav-link i { margin-right: 12px; font-size: 1.1rem; }
        
        /* Cards */
        .card-stat { 
            border: none; 
            border-radius: 10px; 
            padding: 20px; 
            background: white; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            height: 100%; 
            transition: transform 0.2s;
        }
        .card-stat:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .icon-box { 
            width: 48px; height: 48px; 
            border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.5rem; margin-bottom: 15px; 
        }
        
        /* Status Badges */
        .badge-status { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .st-ok { background: #dcfce7; color: #15803d; }
        .st-warn { background: #fef9c3; color: #a16207; }
        .st-err { background: #fee2e2; color: #b91c1c; }
        .st-fix { background: #e0f2fe; color: #0369a1; }

        /* Responsive Mobile */
        @media (max-width: 768px) {
            #sidebar { margin-left: calc(-1 * var(--sidebar-width)); }
            #sidebar.active { margin-left: 0; }
            #content { margin-left: 0; }
            .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; }
            .overlay.active { display: block; }
        }
    </style>
</head>
<body>

<div class="overlay" onclick="toggleSidebar()"></div>

<div id="wrapper">
    <!-- SIDEBAR -->
    <nav id="sidebar">
        <div class="brand">
            <h5 class="fw-bold m-0 text-primary"><i class="bi bi-shield-plus"></i> MEQ System</h5>
            <small class="text-muted">Qu·∫£n l√Ω TB Y T·∫ø</small>
        </div>
        <div class="py-2 flex-grow-1">
            <a href="#" class="nav-link active" onclick="showView('dashboard')"><i class="bi bi-grid-1x2"></i> T·ªïng quan</a>
            <a href="#" class="nav-link" onclick="showView('inventory')"><i class="bi bi-box-seam"></i> Danh s√°ch Thi·∫øt b·ªã</a>
            <a href="#" class="nav-link" onclick="showView('maintenance')">
                <i class="bi bi-tools"></i> B·∫£o tr√¨ & S·ª≠a ch·ªØa
                <span class="badge bg-danger ms-auto rounded-pill" id="badge-repair" style="display:none">0</span>
            </a>
            <a href="#" class="nav-link" onclick="showView('calendar')"><i class="bi bi-calendar-event"></i> L·ªãch Ki·ªÉm ƒë·ªãnh</a>
        </div>
        <div class="p-3 border-top bg-light">
             <div class="d-flex align-items-center mb-2">
                 <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width:32px;height:32px"><i class="bi bi-person"></i></div>
                 <div>
                     <small class="d-block fw-bold text-dark">Admin</small>
                     <small class="d-block text-muted" style="font-size:0.7rem">Ph√≤ng V·∫≠t T∆∞</small>
                 </div>
             </div>
             <button class="btn btn-outline-primary w-100 btn-sm" onclick="fetchData()"><i class="bi bi-arrow-clockwise"></i> ƒê·ªìng b·ªô d·ªØ li·ªáu</button>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div id="content">
        <!-- Mobile Toggle -->
        <button class="btn btn-white shadow-sm d-md-none mb-3 border" onclick="toggleSidebar()"><i class="bi bi-list"></i> Menu</button>

        <!-- VIEW 1: DASHBOARD -->
        <div id="view-dashboard" class="view-section">
            <h4 class="fw-bold mb-4 text-secondary">B·∫£ng tin ho·∫°t ƒë·ªông</h4>
            
            <!-- Stats Row -->
            <div class="row g-3 mb-4">
                <div class="col-md-3 col-6">
                    <div class="card-stat">
                        <div class="icon-box bg-primary bg-opacity-10 text-primary"><i class="bi bi-hdd-stack"></i></div>
                        <h2 class="fw-bold m-0" id="stat-total">0</h2>
                        <small class="text-muted fw-bold">T·ªîNG THI·∫æT B·ªä</small>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card-stat">
                        <div class="icon-box bg-danger bg-opacity-10 text-danger"><i class="bi bi-exclamation-triangle"></i></div>
                        <h2 class="fw-bold m-0 text-danger" id="stat-expired">0</h2>
                        <small class="text-muted fw-bold">QU√Å H·∫†N Kƒê</small>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card-stat">
                        <div class="icon-box bg-warning bg-opacity-10 text-warning"><i class="bi bi-wrench"></i></div>
                        <h2 class="fw-bold m-0 text-warning" id="stat-fixing">0</h2>
                        <small class="text-muted fw-bold">ƒêANG S·ª¨A CH·ªÆA</small>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card-stat">
                        <div class="icon-box bg-success bg-opacity-10 text-success"><i class="bi bi-check-circle"></i></div>
                        <h2 class="fw-bold m-0 text-success" id="stat-ready">0</h2>
                        <small class="text-muted fw-bold">S·∫¥N S√ÄNG</small>
                    </div>
                </div>
            </div>
            
            <!-- Charts Row -->
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card-stat">
                        <h6 class="fw-bold text-secondary mb-3">Ph√¢n b·ªë T√†i s·∫£n theo Khoa/Ph√≤ng</h6>
                        <div style="height: 300px;"><canvas id="chartDept"></canvas></div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card-stat">
                        <h6 class="fw-bold text-secondary mb-3">T√¨nh tr·∫°ng Thi·∫øt b·ªã</h6>
                        <div style="height: 250px; position: relative;">
                            <canvas id="chartStatus"></canvas>
                        </div>
                        <div class="mt-3 text-center small text-muted">
                            Bi·ªÉu ƒë·ªì th·ªÉ hi·ªán t·ª∑ l·ªá thi·∫øt b·ªã s·∫µn s√†ng so v·ªõi h∆∞ h·ªèng/h·∫øt h·∫°n.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: INVENTORY LIST -->
        <div id="view-inventory" class="view-section d-none">
            <div class="card-stat p-0 overflow-hidden">
                <div class="p-3 border-bottom bg-white d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <h5 class="fw-bold text-secondary m-0">Danh s√°ch Thi·∫øt b·ªã</h5>
                    <div class="d-flex gap-2 flex-wrap">
                        <select id="filter-cat" class="form-select form-select-sm" style="min-width:150px" onchange="renderTable()"><option value="">üìÇ T·∫•t c·∫£ nh√≥m</option></select>
                        <select id="filter-dept" class="form-select form-select-sm" style="min-width:150px" onchange="renderTable()"><option value="">üè• T·∫•t c·∫£ khoa</option></select>
                        <input type="text" id="search-box" class="form-control form-control-sm" placeholder="üîç T√¨m t√™n, model..." style="min-width:200px" onkeyup="renderTable()">
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-secondary small text-uppercase">
                            <tr>
                                <th class="ps-3">T√™n thi·∫øt b·ªã / Nh√≥m</th>
                                <th>Khoa/Ph√≤ng</th>
                                <th>Th√¥ng s·ªë (Model/Seri)</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Ng∆∞·ªùi PT</th>
                                <th class="text-end pe-3">T√°c v·ª•</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-body">
                            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c JS render v√†o ƒë√¢y -->
                        </tbody>
                    </table>
                </div>
                <div class="p-2 border-top bg-light text-end small text-muted">
                    Hi·ªÉn th·ªã <span id="row-count" class="fw-bold">0</span> thi·∫øt b·ªã
                </div>
            </div>
        </div>

        <!-- VIEW 3: MAINTENANCE -->
        <div id="view-maintenance" class="view-section d-none">
            <div class="row g-4">
                <!-- Form B√°o H·ªèng -->
                <div class="col-md-4">
                    <div class="card-stat border-top border-4 border-danger bg-white">
                        <h5 class="fw-bold text-danger mb-4"><i class="bi bi-lightning-charge"></i> B√°o H·ªèng Nhanh</h5>
                        <form id="form-report">
                            <div class="mb-3">
                                <label class="small fw-bold text-muted">Ch·ªçn thi·∫øt b·ªã l·ªói</label>
                                <select id="rpt-device" class="form-select" required></select>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-bold text-muted">Lo·∫°i s·ª± c·ªë</label>
                                <select id="rpt-type" class="form-select">
                                    <option>S·ª≠a ch·ªØa (H·ªèng h√≥c)</option>
                                    <option>Ki·ªÉm ƒë·ªãnh l·∫°i</option>
                                    <option>B·∫£o d∆∞·ª°ng ƒë·ªãnh k·ª≥</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-bold text-muted">M√¥ t·∫£ chi ti·∫øt</label>
                                <textarea id="rpt-content" class="form-control" rows="3" placeholder="M√°y kh√¥ng l√™n ngu·ªìn, b√°o l·ªói E04..." required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-bold text-muted">Ng∆∞·ªùi b√°o c√°o</label>
                                <input id="rpt-by" class="form-control" placeholder="T√™n c·ªßa b·∫°n" required>
                            </div>
                            <button type="submit" class="btn btn-danger w-100 fw-bold py-2">G·ª¨I Y√äU C·∫¶U</button>
                        </form>
                    </div>
                </div>
                
                <!-- B·∫£ng L·ªãch S·ª≠ -->
                <div class="col-md-8">
                    <div class="card-stat">
                        <h5 class="fw-bold text-secondary mb-3">L·ªãch s·ª≠ S·ª≠a ch·ªØa & B·∫£o d∆∞·ª°ng</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm align-middle">
                                <thead class="table-primary">
                                    <tr>
                                        <th>Ng√†y b√°o</th>
                                        <th>Thi·∫øt b·ªã</th>
                                        <th>N·ªôi dung</th>
                                        <th>Tr·∫°ng th√°i</th>
                                        <th>Ng∆∞·ªùi b√°o</th>
                                    </tr>
                                </thead>
                                <tbody id="repair-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- VIEW 4: CALENDAR -->
        <div id="view-calendar" class="view-section d-none">
             <div class="card-stat">
                 <h5 class="fw-bold text-secondary mb-3">L·ªãch Ki·ªÉm ƒë·ªãnh S·∫Øp t·ªõi</h5>
                 <div id="calendar"></div>
             </div>
        </div>
    </div>
</div>

<!-- JAVASCRIPT LOGIC -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ==========================================
    // 1. C·∫§U H√åNH LI√äN K·∫æT (Backend URL)
    // ==========================================
    // H√£y d√°n Link Web App t·ª´ b∆∞·ªõc Deploy Google Script v√†o ƒë√¢y:
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwrRzoB2nRxdQXztD-Juy4dSgnKY_V2dWAP_QbNOaA_pOu28gqfdjnhfjXAr3bv7-mH/exec";

    // ==========================================
    // 2. D·ªÆ LI·ªÜU DEMO (Ch·∫°y khi ch∆∞a c√≥ m·∫°ng/script)
    // ==========================================
    const DEMO_DATA = [
        ["I. ATBX", "M√°y CT-Scanner", "Khoa CƒêHA", "MX135CTX", "102664BG0", "6/27/2026", "Ki·ªÅu M·∫°nh To√†n"],
        ["I. ATBX", "X-quang t·ªïng h·ª£p", "Khoa CƒêHA", "AccuRay525R", "A050521K092", "2/14/2028", "Ki·ªÅu M·∫°nh To√†n"],
        ["II. TT05", "M√°y ch·∫°y th·∫≠n", "L·ªçc Th·∫≠n", "4008S", "2SXA4COY", "11/29/2025", "ƒê·ªó Th·ªã Ph∆∞∆°ng"],
        ["II. TT05", "M√°y th·ªü", "HSCC", "PB 840", "3512171233", "11/29/2026", "ƒê·ªó Th·ªã Ph∆∞∆°ng"],
        ["III. Lo·∫°i 2", "M√°y ƒëi·ªán tim 6 c·∫ßn", "HSCC", "ECG-1250K", "16889", "12/31/2026", "ƒê·ªó Th·ªã Ph∆∞∆°ng"],
        ["III. Lo·∫°i 2", "Monitor 5 th√¥ng s·ªë", "Ngo·∫°i", "PVM-2701", "07652", "10/10/2024", "L√™ Th·ªã Minh Th∆∞"], // Qu√° h·∫°n v√≠ d·ª•
        ["IV. B·∫£o d∆∞·ª°ng", "B∆°m ti√™m ƒëi·ªán", "HSCC", "TE331", "9080133", "12/31/2026", "ƒê·ªó Th·ªã Ph∆∞∆°ng"],
        ["IV. B·∫£o d∆∞·ª°ng", "M√°y XN Huy·∫øt h·ªçc", "X√©t Nghi·ªám", "OX-560", "TA1104B", "12/31/2026", "Ph·∫°m Tr·∫ßn Quy·∫øt"]
    ];

    // Bi·∫øn to√†n c·ª•c
    let devices = [];
    let repairs = [];
    let charts = {};
    let calendarInstance = null;

    // --- KH·ªûI CH·∫†Y ---
    document.addEventListener('DOMContentLoaded', () => {
        // N·∫°p demo tr∆∞·ªõc ƒë·ªÉ hi·ªán giao di·ªán ngay
        processData(DEMO_DATA, []);
        
        // Sau ƒë√≥ th·ª≠ t·∫£i d·ªØ li·ªáu th·∫≠t
        if(!SCRIPT_URL.includes("THAY_LINK")) fetchData();
        
        // X·ª≠ l√Ω s·ª± ki·ªán form
        document.getElementById('form-report').addEventListener('submit', handleReport);
    });

    // --- H√ÄM ƒê·ªîI TAB VIEW ---
    function showView(viewId) {
        // ·∫®n t·∫•t c·∫£ view
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
        // Hi·ªán view ƒë∆∞·ª£c ch·ªçn
        document.getElementById(`view-${viewId}`).classList.remove('d-none');
        
        // C·∫≠p nh·∫≠t menu active
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        // Mobile: T·ª± ƒë·ªông ƒë√≥ng sidebar khi ch·ªçn menu
        if(window.innerWidth < 768) toggleSidebar();

        // Render l·∫°i l·ªãch n·∫øu v√†o tab l·ªãch (ƒë·ªÉ fix l·ªói hi·ªÉn th·ªã size)
        if(viewId === 'calendar' && !calendarInstance) {
            renderCalendar();
        } else if (viewId === 'calendar') {
            calendarInstance.render();
        }
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
        document.querySelector('.overlay').classList.toggle('active');
    }

    // --- T·∫¢I D·ªÆ LI·ªÜU T·ª™ SERVER ---
    async function fetchData() {
        const btn = document.querySelector('button[onclick="fetchData()"]');
        const oldText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang t·∫£i...';
        btn.disabled = true;

        try {
            const [resDev, resRep] = await Promise.all([
                fetch(`${SCRIPT_URL}?action=read_devices`).then(r => r.json()),
                fetch(`${SCRIPT_URL}?action=read_repairs`).then(r => r.json())
            ]);

            if(resDev.status === 'success') {
                processData(resDev.data, resRep.data || []);
                // alert("ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi nh·∫•t!");
            } else {
                alert("L·ªói t·∫£i d·ªØ li·ªáu: " + resDev.message);
            }
        } catch(e) {
            console.error(e);
            alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi Server!");
        } finally {
            btn.innerHTML = oldText;
            btn.disabled = false;
        }
    }

    // --- X·ª¨ L√ù D·ªÆ LI·ªÜU ---
    function processData(devData, repData) {
        repairs = repData;
        
        // Map d·ªØ li·ªáu m·∫£ng sang Object ƒë·ªÉ d·ªÖ d√πng
        devices = devData.map((r, i) => {
            // C·ªôt Backend tr·∫£ v·ªÅ: [0:Group, 1:Name, 2:Dept, 3:Model, 4:Serial, 5:Expiry, 6:Resp]
            const name = r[1];
            const expiry = r[5];
            
            // Check xem m√°y n√†y c√≥ ƒëang s·ª≠a kh√¥ng? (C√≥ phi·∫øu Pending trong repairs)
            const isFixing = repairs.some(rep => rep[3] === name && rep[5] === 'Pending');
            
            return {
                id: i,
                cat: r[0],
                name: name,
                dept: r[2],
                model: r[3],
                serial: r[4],
                expiry: expiry,
                resp: r[6],
                isFixing: isFixing,
                // T√≠nh tr·∫°ng th√°i h·∫°n d√πng
                statusTime: calcDateStatus(expiry) 
            };
        });

        updateDashboard();
        populateFilters();
        renderTable();
        renderRepairHistory();
    }

    function calcDateStatus(dateStr) {
        if(!dateStr) return 'ok';
        const expDate = new Date(dateStr);
        if(isNaN(expDate)) return 'ok';
        const today = new Date();
        const diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
        
        if(diffDays < 0) return 'expired';
        if(diffDays <= 30) return 'warning';
        return 'ok';
    }

    // --- RENDER GIAO DI·ªÜN ---
    
    // 1. Dashboard
    function updateDashboard() {
        const total = devices.length;
        const expired = devices.filter(d => d.statusTime === 'expired').length;
        const fixing = devices.filter(d => d.isFixing).length;
        const ready = total - expired - fixing;

        document.getElementById('stat-total').innerText = total;
        document.getElementById('stat-expired').innerText = expired;
        document.getElementById('stat-fixing').innerText = fixing;
        document.getElementById('stat-ready').innerText = ready;

        // V·∫Ω bi·ªÉu ƒë·ªì Khoa
        const deptCount = {};
        devices.forEach(d => deptCount[d.dept] = (deptCount[d.dept] || 0) + 1);
        renderChart('chartDept', 'bar', Object.keys(deptCount), Object.values(deptCount), '#0e7490');

        // V·∫Ω bi·ªÉu ƒë·ªì Tr·∫°ng th√°i
        renderChart('chartStatus', 'doughnut', ['S·∫µn s√†ng', 'H·∫øt h·∫°n', 'ƒêang s·ª≠a'], [ready, expired, fixing], ['#15803d', '#b91c1c', '#eab308']);
    }

    function renderChart(id, type, labels, data, colors) {
        if(charts[id]) charts[id].destroy();
        const ctx = document.getElementById(id).getContext('2d');
        charts[id] = new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{ 
                    data: data, 
                    backgroundColor: Array.isArray(colors) ? colors : colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } }
            }
        });
    }

    // 2. Table Inventory
    function renderTable() {
        const tbody = document.getElementById('inventory-body');
        tbody.innerHTML = '';
        
        const fCat = document.getElementById('filter-cat').value;
        const fDept = document.getElementById('filter-dept').value;
        const search = document.getElementById('search-box').value.toLowerCase();

        const filtered = devices.filter(d => {
            const mCat = !fCat || d.cat === fCat;
            const mDept = !fDept || d.dept === fDept;
            const mSearch = !search || d.name.toLowerCase().includes(search) || d.model.toLowerCase().includes(search);
            return mCat && mDept && mSearch;
        });

        document.getElementById('row-count').innerText = filtered.length;

        filtered.forEach(d => {
            let badge = '';
            // ∆Øu ti√™n tr·∫°ng th√°i: ƒêang s·ª≠a > H·∫øt h·∫°n > S·∫Øp h·∫øt > OK
            if (d.isFixing) badge = '<span class="badge-status st-fix">üõ†Ô∏è ƒêang s·ª≠a</span>';
            else if (d.statusTime === 'expired') badge = '<span class="badge-status st-err">‚õî H·∫øt h·∫°n</span>';
            else if (d.statusTime === 'warning') badge = '<span class="badge-status st-warn">‚ö†Ô∏è S·∫Øp h·∫øt h·∫°n</span>';
            else badge = '<span class="badge-status st-ok">‚úÖ Ho·∫°t ƒë·ªông t·ªët</span>';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="ps-3">
                    <div class="fw-bold text-dark">${d.name}</div>
                    <small class="text-muted fst-italic">${d.cat}</small>
                </td>
                <td><span class="badge bg-light text-dark border">${d.dept}</span></td>
                <td>
                    <div class="small">Model: <strong>${d.model}</strong></div>
                    <div class="small text-muted">SN: ${d.serial}</div>
                </td>
                <td>
                    ${badge}
                    <div class="small text-muted mt-1">H·∫°n: ${d.expiry}</div>
                </td>
                <td><small>${d.resp}</small></td>
                <td class="text-end pe-3">
                    <button class="btn btn-sm btn-outline-danger" title="B√°o h·ªèng" onclick="quickReport('${d.name}')"><i class="bi bi-lightning"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 3. Populate Filters & Form Select
    function populateFilters() {
        const cats = [...new Set(devices.map(d => d.cat))].sort();
        const depts = [...new Set(devices.map(d => d.dept))].sort();
        
        const sCat = document.getElementById('filter-cat');
        const sDept = document.getElementById('filter-dept');
        const sRpt = document.getElementById('rpt-device'); // Select trong form b√°o h·ªèng

        // Gi·ªØ l·∫°i option ƒë·∫ßu ti√™n, x√≥a c√°c option c≈©
        while(sCat.options.length > 1) sCat.remove(1);
        while(sDept.options.length > 1) sDept.remove(1);
        sRpt.innerHTML = ''; 

        cats.forEach(c => sCat.add(new Option(c, c)));
        depts.forEach(d => sDept.add(new Option(d, d)));
        
        // Populate report dropdown
        devices.forEach(d => {
            const opt = new Option(`${d.name} (${d.dept})`, d.name);
            sRpt.add(opt);
        });
    }

    // 4. Render Repairs
    function renderRepairHistory() {
        const tbody = document.getElementById('repair-body');
        tbody.innerHTML = '';
        let pendingCount = 0;

        repairs.forEach(r => {
            // BaoTri Sheet: [0:ID, 1:Date, 2:Type, 3:Device, 4:Content, 5:Status, 6:Reporter]
            const isPending = r[5] === 'Pending';
            if(isPending) pendingCount++;
            
            const badge = isPending ? '<span class="badge bg-warning text-dark">Ch·ªù x·ª≠ l√Ω</span>' : '<span class="badge bg-success">Ho√†n th√†nh</span>';
            const dateStr = new Date(r[1]).toLocaleDateString('vi-VN');

            tbody.innerHTML += `
                <tr>
                    <td>${dateStr}</td>
                    <td class="fw-bold">${r[3]}</td>
                    <td><span class="badge bg-light text-dark border me-1">${r[2]}</span> ${r[4]}</td>
                    <td>${badge}</td>
                    <td><small>${r[6]}</small></td>
                </tr>
            `;
        });

        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng badge ƒë·ªè tr√™n menu
        const badgeEl = document.getElementById('badge-repair');
        if(pendingCount > 0) {
            badgeEl.innerText = pendingCount;
            badgeEl.style.display = 'inline-block';
        } else {
            badgeEl.style.display = 'none';
        }
    }

    // 5. Render Calendar
    function renderCalendar() {
        const events = devices
            .filter(d => d.statusTime !== 'ok') // Ch·ªâ hi·ªán m√°y c√≥ v·∫•n ƒë·ªÅ h·∫°n d√πng
            .map(d => ({
                title: `${d.name} (${d.dept})`,
                start: formatDateForCal(d.expiry),
                color: d.statusTime === 'expired' ? '#dc3545' : '#eab308'
            }));

        const calendarEl = document.getElementById('calendar');
        calendarEl.innerHTML = '';
        calendarInstance = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'vi',
            height: 500,
            events: events,
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'listMonth' }
        });
        calendarInstance.render();
    }

    // --- C√ÅC H√ÄM TI·ªÜN √çCH ---
    function quickReport(devName) {
        showView('maintenance');
        document.getElementById('rpt-device').value = devName;
        document.getElementById('rpt-content').focus();
    }

    async function handleReport(e) {
        e.preventDefault();
        if(SCRIPT_URL.includes("THAY_LINK")) return alert("Ch∆∞a c·∫•u h√¨nh Backend! Vui l√≤ng l√†m theo h∆∞·ªõng d·∫´n.");

        const btn = e.target.querySelector('button');
        const oldText = btn.innerText;
        btn.innerText = "ƒêang g·ª≠i..."; btn.disabled = true;

        const payload = {
            action: 'add_repair',
            device: document.getElementById('rpt-device').value,
            type: document.getElementById('rpt-type').value,
            content: document.getElementById('rpt-content').value,
            by: document.getElementById('rpt-by').value
        };

        try {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            }).then(r => r.json());

            if(res.status === 'success') {
                alert("‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu th√†nh c√¥ng!");
                e.target.reset();
                fetchData(); // T·∫£i l·∫°i d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
            } else {
                alert("‚õî L·ªói: " + res.message);
            }
        } catch(err) {
            alert("L·ªói k·∫øt n·ªëi!");
        } finally {
            btn.innerText = oldText; btn.disabled = false;
        }
    }

    function formatDateForCal(str) {
        if(!str) return new Date();
        // Gi·∫£ ƒë·ªãnh format trong sheet l√† m/d/yyyy (Google m·∫∑c ƒë·ªãnh) ho·∫∑c d/m/yyyy
        // C·∫ßn ƒë·∫£m b·∫£o tr·∫£ v·ªÅ YYYY-MM-DD
        const d = new Date(str);
        if(isNaN(d)) return new Date();
        return d.toISOString().split('T')[0];
    }
</script>

</body>
</html>
