<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Qu·∫£n l√Ω TTBYT</title>
    <!-- Bootstrap 5.3 & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Chart.js for better Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    
    <style>
        :root {
            --sidebar-width: 260px;
            --primary-bg: #f8f9fa;
            --primary-color: #0e7490; /* Cyan-700 */
            --accent-color: #06b6d4;
        }

        body { font-family: 'Inter', 'Segoe UI', sans-serif; background-color: #f0f2f5; font-size: 0.9rem; overflow-x: hidden; }
        
        /* Layout Structure */
        #wrapper { display: flex; width: 100%; align-items: stretch; }
        #sidebar { min-width: var(--sidebar-width); max-width: var(--sidebar-width); background: #fff; color: #333; min-height: 100vh; border-right: 1px solid #e0e0e0; transition: all 0.3s; position: fixed; z-index: 1000; }
        #content { width: 100%; margin-left: var(--sidebar-width); min-height: 100vh; transition: all 0.3s; }
        
        /* Sidebar Elements */
        .sidebar-header { padding: 20px; background: var(--primary-color); color: white; }
        .sidebar-menu { padding: 15px 0; list-style: none; }
        .sidebar-menu li a { padding: 12px 25px; display: flex; align-items: center; font-weight: 500; color: #555; text-decoration: none; border-left: 4px solid transparent; transition: 0.2s; }
        .sidebar-menu li a:hover { background: #f1f5f9; color: var(--primary-color); }
        .sidebar-menu li a.active { background: #e0f2fe; color: var(--primary-color); border-left-color: var(--primary-color); }
        .sidebar-menu i { margin-right: 10px; font-size: 1.1rem; }

        /* Card & Stats */
        .stat-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #eee; height: 100%; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .stat-icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; margin-bottom: 15px; }
        
        /* Table Styles */
        .table-custom { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .table-custom thead { background: #f8fafc; color: #64748b; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .table-custom th, .table-custom td { padding: 12px 20px; vertical-align: middle; border-bottom: 1px solid #f1f5f9; }
        
        /* Status Badges */
        .badge-status { padding: 5px 10px; border-radius: 20px; font-weight: 600; font-size: 0.75rem; display: inline-flex; align-items: center; }
        .badge-status::before { content: ''; width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; }
        
        .st-ok { background: #dcfce7; color: #166534; } .st-ok::before { background: #166534; }
        .st-warn { background: #fef9c3; color: #854d0e; } .st-warn::before { background: #854d0e; }
        .st-err { background: #fee2e2; color: #991b1b; } .st-err::before { background: #991b1b; }
        .st-fix { background: #e0f2fe; color: #075985; } .st-fix::before { background: #075985; } /* ƒêang s·ª≠a */

        /* Responsive */
        @media (max-width: 768px) {
            #sidebar { margin-left: calc(-1 * var(--sidebar-width)); }
            #sidebar.active { margin-left: 0; }
            #content { margin-left: 0; }
        }
        
        /* Modal Profile */
        .profile-header { background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); color: white; padding: 20px; border-radius: 10px 10px 0 0; }
        .timeline { border-left: 2px solid #e0e0e0; margin-left: 10px; padding-left: 20px; position: relative; }
        .timeline-item { margin-bottom: 20px; position: relative; }
        .timeline-item::before { content: ''; width: 12px; height: 12px; background: white; border: 2px solid var(--primary-color); border-radius: 50%; position: absolute; left: -27px; top: 0; }
        
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<!-- Loading Screen -->
<div id="loading">
    <div class="spinner-grow text-primary mb-2" role="status"></div>
    <h6 class="text-primary fw-bold">ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu...</h6>
    <small class="text-muted">Vui l√≤ng ƒë·ª£i gi√¢y l√°t</small>
</div>

<div id="wrapper">
    <!-- SIDEBAR -->
    <nav id="sidebar">
        <div class="sidebar-header">
            <h5 class="mb-0 fw-bold"><i class="bi bi-shield-plus"></i> MEQ Manager</h5>
            <small class="opacity-75">Qu·∫£n l√Ω TB Y T·∫ø</small>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" class="active" onclick="switchTab('dashboard')"><i class="bi bi-grid-1x2"></i> T·ªïng quan</a></li>
            <li><a href="#" onclick="switchTab('inventory')"><i class="bi bi-box-seam"></i> Danh s√°ch Thi·∫øt b·ªã</a></li>
            <li><a href="#" onclick="switchTab('maintenance')"><i class="bi bi-tools"></i> B·∫£o tr√¨ & S·ª≠a ch·ªØa <span class="badge bg-danger ms-auto rounded-pill" id="badge-repair-count" style="display:none">0</span></a></li>
            <li><a href="#" onclick="switchTab('calendar')"><i class="bi bi-calendar-event"></i> L·ªãch Ki·ªÉm ƒë·ªãnh</a></li>
        </ul>
        <div class="mt-auto p-3 text-center border-top">
             <button class="btn btn-sm btn-outline-secondary w-100" onclick="fetchData()"><i class="bi bi-arrow-clockwise"></i> ƒê·ªìng b·ªô l·∫°i</button>
        </div>
    </nav>

    <!-- CONTENT -->
    <div id="content" class="p-4">
        <!-- Topbar Mobile Toggle -->
        <button class="btn btn-primary d-md-none mb-3" onclick="document.getElementById('sidebar').classList.toggle('active')"><i class="bi bi-list"></i></button>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="view-section">
            <h4 class="fw-bold mb-4 text-secondary">T·ªïng quan Ho·∫°t ƒë·ªông</h4>
            
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon bg-primary bg-opacity-10 text-primary"><i class="bi bi-hdd-stack"></i></div>
                        <h3 class="fw-bold mb-0" id="stat-total">0</h3>
                        <small class="text-muted">T·ªïng thi·∫øt b·ªã</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon bg-danger bg-opacity-10 text-danger"><i class="bi bi-exclamation-triangle"></i></div>
                        <h3 class="fw-bold mb-0" id="stat-expired">0</h3>
                        <small class="text-muted">H·∫øt h·∫°n ki·ªÉm ƒë·ªãnh</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon bg-warning bg-opacity-10 text-warning"><i class="bi bi-wrench-adjustable"></i></div>
                        <h3 class="fw-bold mb-0" id="stat-repairing">0</h3>
                        <small class="text-muted">ƒêang b√°o h·ªèng/s·ª≠a</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon bg-success bg-opacity-10 text-success"><i class="bi bi-check-circle"></i></div>
                        <h3 class="fw-bold mb-0" id="stat-ready">0</h3>
                        <small class="text-muted">S·∫µn s√†ng s·ª≠ d·ª•ng</small>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-8">
                    <div class="card border-0 shadow-sm p-3 h-100">
                        <h6 class="fw-bold text-secondary mb-3">Ph√¢n b·ªë T√†i s·∫£n theo Khoa</h6>
                        <canvas id="chartDept"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm p-3 h-100">
                        <h6 class="fw-bold text-secondary mb-3">T·ª∑ l·ªá Tr·∫°ng th√°i</h6>
                        <canvas id="chartStatus"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: INVENTORY -->
        <div id="view-inventory" class="view-section d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold text-secondary">Danh s√°ch Thi·∫øt b·ªã</h4>
                <div class="d-flex gap-2">
                    <input type="text" id="search-input" class="form-control" placeholder="T√¨m t√™n, model, seri..." onkeyup="filterTable()">
                    <select id="filter-dept" class="form-select w-auto" onchange="filterTable()"><option value="">T·∫•t c·∫£ khoa</option></select>
                </div>
            </div>

            <div class="table-custom">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Thi·∫øt b·ªã</th>
                                <th>Khoa / Ph√≤ng</th>
                                <th>Model / Serial</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Ng∆∞·ªùi PT</th>
                                <th class="text-end">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-body">
                            <!-- JS render -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW: MAINTENANCE -->
        <div id="view-maintenance" class="view-section d-none">
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm p-4 h-100">
                        <h5 class="fw-bold text-primary mb-3"><i class="bi bi-pencil-square"></i> T·∫°o Phi·∫øu Y√™u C·∫ßu</h5>
                        <form id="form-report">
                            <div class="mb-3">
                                <label class="form-label small fw-bold text-muted">Thi·∫øt b·ªã g·∫∑p s·ª± c·ªë</label>
                                <select id="rpt-device" class="form-select" required></select>
                                <div class="form-text">Ch·ªâ hi·ªán thi·∫øt b·ªã ƒëang ho·∫°t ƒë·ªông</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold text-muted">Lo·∫°i y√™u c·∫ßu</label>
                                <select id="rpt-type" class="form-select">
                                    <option value="S·ª≠a ch·ªØa">üõ†Ô∏è B√°o h·ªèng (S·ª≠a ch·ªØa)</option>
                                    <option value="Ki·ªÉm ƒë·ªãnh">üìÖ Xin l·ªãch Ki·ªÉm ƒë·ªãnh l·∫°i</option>
                                    <option value="B·∫£o d∆∞·ª°ng">üßΩ B·∫£o d∆∞·ª°ng ƒë·ªãnh k·ª≥</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold text-muted">M√¥ t·∫£ chi ti·∫øt</label>
                                <textarea id="rpt-content" class="form-control" rows="3" placeholder="M√¥ t·∫£ l·ªói, hi·ªán t∆∞·ª£ng..." required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold text-muted">Ng∆∞·ªùi b√°o</label>
                                <input id="rpt-by" type="text" class="form-control" required placeholder="T√™n c√°n b·ªô...">
                            </div>
                            <button type="submit" class="btn btn-primary w-100 fw-bold">G·ª¨I Y√äU C·∫¶U</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card border-0 shadow-sm p-4 h-100">
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="fw-bold text-secondary">Theo d√µi Ti·∫øn ƒë·ªô S·ª≠a ch·ªØa</h5>
                            <span class="badge bg-light text-dark border" id="ticket-count">0 phi·∫øu</span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Ng√†y</th>
                                        <th>Thi·∫øt b·ªã</th>
                                        <th>S·ª± c·ªë</th>
                                        <th>Tr·∫°ng th√°i</th>
                                        <th>Ng∆∞·ªùi b√°o</th>
                                    </tr>
                                </thead>
                                <tbody id="repair-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: CALENDAR -->
        <div id="view-calendar" class="view-section d-none">
            <div class="card border-0 shadow-sm p-3">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- DEVICE DETAILS MODAL -->
<div class="modal fade" id="modalDevice" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 overflow-hidden rounded-3">
            <div class="profile-header">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="fw-bold mb-1" id="m-name">T√™n Thi·∫øt B·ªã</h4>
                        <span class="badge bg-white text-primary" id="m-model">Model XYZ</span>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <div class="col-md-6 border-end">
                        <h6 class="fw-bold text-secondary mb-3">Th√¥ng tin chi ti·∫øt</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2"><strong>Khoa/Ph√≤ng:</strong> <span id="m-dept">--</span></li>
                            <li class="mb-2"><strong>Serial:</strong> <span id="m-serial">--</span></li>
                            <li class="mb-2"><strong>Ng∆∞·ªùi qu·∫£n l√Ω:</strong> <span id="m-resp">--</span></li>
                            <li class="mb-2"><strong>H·∫°n ki·ªÉm ƒë·ªãnh:</strong> <span id="m-expiry" class="badge bg-secondary">--</span></li>
                        </ul>
                        <div class="mt-4 p-3 bg-light rounded text-center">
                            <small class="d-block text-muted mb-2">QR ƒê·ªãnh danh</small>
                            <canvas id="qr-canvas"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold text-secondary mb-3">L·ªãch s·ª≠ B·∫£o tr√¨ & S·ª± c·ªë</h6>
                        <div class="timeline" id="m-timeline">
                            <!-- Timeline items generated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button class="btn btn-outline-danger btn-sm" onclick="reportFromModal()">‚ö†Ô∏è B√°o h·ªèng thi·∫øt b·ªã n√†y</button>
            </div>
        </div>
    </div>
</div>

<!-- QR Lib -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<script>
    // --- CONFIGURATION ---
    // ‚ö†Ô∏è QUAN TR·ªåNG: Thay link Google App Script c·ªßa b·∫°n v√†o ƒë√¢y
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyDIAkOgafhcbbfqZKVblr4_I_F31DaAlDuDZZnuV-Uj1fyW-vwL7z9vxHBbyd0Rgbb/exec"; 

    // Global State
    let devices = [];
    let repairs = [];
    let calendarInstance = null;
    let charts = {};

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        if(SCRIPT_URL.includes("THAY_LINK")) {
            alert("Vui l√≤ng c·∫•u h√¨nh SCRIPT_URL trong code HTML!");
            document.getElementById('loading').innerHTML = '<div class="text-danger">Ch∆∞a c·∫•u h√¨nh li√™n k·∫øt Backend!</div>';
            return;
        }
        fetchData();
        
        // Form Submit
        document.getElementById('form-report').addEventListener('submit', handleReportSubmit);
    });

    // --- CORE LOGIC: FETCH & PROCESS ---
    async function fetchData() {
        document.getElementById('loading').classList.remove('d-none');
        try {
            const [resDev, resRep] = await Promise.all([
                fetch(`${SCRIPT_URL}?action=read_devices`).then(r => r.json()),
                fetch(`${SCRIPT_URL}?action=read_repairs`).then(r => r.json())
            ]);

            if(resDev.status === 'success') {
                repairs = resRep.data || []; // Load repairs first to map status
                processDevices(resDev.data);
                renderApp();
            }
        } catch (e) {
            console.error(e);
            alert("L·ªói k·∫øt n·ªëi d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra l·∫°i m·∫°ng ho·∫∑c link Script.");
        } finally {
            document.getElementById('loading').classList.add('d-none');
        }
    }

    function processDevices(rawData) {
        // Map CSV array to Object
        // Data format: [Group, Name, Dept, Model, Serial, Expiry, Responsible]
        devices = rawData.map((r, idx) => {
            const expiryDate = r[5];
            const name = r[1];
            
            // Logic: Check if device is currently under repair (Pending status in Repair sheet)
            const activeRepair = repairs.find(rep => rep[3] === name && rep[5] === 'Pending');
            
            return {
                id: idx,
                group: r[0],
                name: r[1],
                dept: r[2],
                model: r[3],
                serial: r[4],
                expiry: expiryDate,
                resp: r[6],
                repairStatus: activeRepair ? 'fixing' : 'active', // Logical Status
                expiryStatus: calcExpiryStatus(expiryDate) // Time Status
            };
        });
    }

    function calcExpiryStatus(dateStr) {
        if(!dateStr) return { code: 'ok', days: 999 };
        const exp = new Date(dateStr);
        const now = new Date();
        const diff = Math.ceil((exp - now) / (1000 * 3600 * 24));
        
        if (isNaN(diff)) return { code: 'ok', days: 999 };
        if (diff < 0) return { code: 'expired', days: diff };
        if (diff <= 30) return { code: 'warning', days: diff };
        return { code: 'ok', days: diff };
    }

    // --- RENDERING UI ---
    function renderApp() {
        renderDashboard();
        renderInventory();
        renderRepairsList();
        renderCalendar();
        populateDropdowns();
    }

    function renderInventory() {
        const tbody = document.getElementById('inventory-body');
        tbody.innerHTML = '';
        
        devices.forEach(d => {
            // Determine combined status
            let statusBadge = '';
            let rowClass = '';
            
            if (d.repairStatus === 'fixing') {
                statusBadge = `<span class="badge-status st-fix">üõ†Ô∏è ƒêang s·ª≠a ch·ªØa</span>`;
                rowClass = 'table-warning';
            } else if (d.expiryStatus.code === 'expired') {
                statusBadge = `<span class="badge-status st-err">‚õî H·∫øt h·∫°n Kƒê</span>`;
            } else if (d.expiryStatus.code === 'warning') {
                statusBadge = `<span class="badge-status st-warn">‚ö†Ô∏è S·∫Øp h·∫øt h·∫°n</span>`;
            } else {
                statusBadge = `<span class="badge-status st-ok">‚úÖ Ho·∫°t ƒë·ªông t·ªët</span>`;
            }

            const tr = document.createElement('tr');
            tr.className = rowClass;
            tr.innerHTML = `
                <td>
                    <div class="fw-bold text-dark">${d.name}</div>
                    <span class="badge bg-light text-secondary border">${d.group}</span>
                </td>
                <td>${d.dept}</td>
                <td><small class="d-block text-muted">${d.model}</small><small class="text-secondary fw-bold">${d.serial}</small></td>
                <td>${statusBadge}<br><small class="text-muted" style="font-size:0.7em">H·∫°n: ${d.expiry}</small></td>
                <td><small>${d.resp}</small></td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-primary" onclick="showDeviceModal(${d.id})"><i class="bi bi-eye"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderRepairsList() {
        const tbody = document.getElementById('repair-body');
        tbody.innerHTML = '';
        let pendingCount = 0;

        repairs.forEach(r => {
            // Sheet BaoTri: ID[0], Date[1], Type[2], Device[3], Content[4], Status[5], By[6]
            const isPending = r[5] === 'Pending';
            if(isPending) pendingCount++;
            
            const badge = isPending ? '<span class="badge bg-warning text-dark">Ch·ªù x·ª≠ l√Ω</span>' : '<span class="badge bg-success">ƒê√£ xong</span>';
            const dateStr = new Date(r[1]).toLocaleDateString('vi-VN');
            
            tbody.innerHTML += `
                <tr>
                    <td>${dateStr}</td>
                    <td class="fw-bold">${r[3]}</td>
                    <td><span class="badge bg-light text-dark border me-1">${r[2]}</span> ${r[4]}</td>
                    <td>${badge}</td>
                    <td><small>${r[6]}</small></td>
                </tr>
            `;
        });
        
        document.getElementById('ticket-count').innerText = `${repairs.length} phi·∫øu`;
        const badge = document.getElementById('badge-repair-count');
        if(pendingCount > 0) {
            badge.innerText = pendingCount;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
        
        // Update Dashboard Stat
        document.getElementById('stat-repairing').innerText = pendingCount;
    }

    function renderDashboard() {
        // Calculate Stats
        const total = devices.length;
        const expired = devices.filter(d => d.expiryStatus.code === 'expired').length;
        // Ready = Total - Expired - Fixing
        const fixing = devices.filter(d => d.repairStatus === 'fixing').length;
        const ready = total - expired - fixing;
        
        document.getElementById('stat-total').innerText = total;
        document.getElementById('stat-expired').innerText = expired;
        document.getElementById('stat-ready').innerText = ready; // Override previous logic
        
        // 1. Chart Dept (Bar)
        const deptCounts = {};
        devices.forEach(d => { deptCounts[d.dept] = (deptCounts[d.dept] || 0) + 1; });
        
        renderChart('chartDept', 'bar', Object.keys(deptCounts), Object.values(deptCounts), 'Thi·∫øt b·ªã theo Khoa', '#0e7490');

        // 2. Chart Status (Doughnut)
        renderChart('chartStatus', 'doughnut', ['S·∫µn s√†ng', 'H·∫øt h·∫°n', 'ƒêang s·ª≠a'], [ready, expired, fixing], 'Tr·∫°ng th√°i', ['#166534', '#991b1b', '#eab308']);
    }

    function renderChart(canvasId, type, labels, data, label, colors) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if(charts[canvasId]) charts[canvasId].destroy(); // Destroy old chart
        
        charts[canvasId] = new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    function renderCalendar() {
        const events = devices
            .filter(d => d.expiryStatus.code !== 'ok')
            .map(d => ({
                title: `${d.name} (${d.dept})`,
                start: formatDateForCal(d.expiry),
                color: d.expiryStatus.code === 'expired' ? '#dc3545' : '#ffc107',
                allDay: true
            }));

        const calendarEl = document.getElementById('calendar');
        calendarEl.innerHTML = ''; // Reset
        
        calendarInstance = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'vi',
            height: 600,
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listMonth' },
            events: events,
            eventClick: function(info) {
                alert('Chi ti·∫øt: ' + info.event.title);
            }
        });
        // We render it but it might need resize when tab shown
    }

    // --- INTERACTION LOGIC ---
    function switchTab(tabId) {
        // 1. Update Menu
        document.querySelectorAll('.sidebar-menu a').forEach(el => el.classList.remove('active'));
        event.target.closest('a').classList.add('active');
        
        // 2. Show View
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
        document.getElementById(`view-${tabId}`).classList.remove('d-none');
        
        // 3. Special handling for Calendar refresh
        if(tabId === 'calendar' && calendarInstance) {
            setTimeout(() => calendarInstance.updateSize(), 200);
        }
    }

    function showDeviceModal(id) {
        const d = devices.find(x => x.id === id);
        if(!d) return;
        
        // Basic Info
        document.getElementById('m-name').innerText = d.name;
        document.getElementById('m-model').innerText = d.model;
        document.getElementById('m-dept').innerText = d.dept;
        document.getElementById('m-serial').innerText = d.serial;
        document.getElementById('m-resp').innerText = d.resp;
        document.getElementById('m-expiry').innerText = d.expiry;
        
        // Generate QR
        new QRious({
            element: document.getElementById('qr-canvas'),
            value: `${d.name}|${d.model}|${d.serial}|${d.dept}`,
            size: 150
        });
        
        // Filter History for this specific device
        const history = repairs.filter(r => r[3] === d.name);
        const tl = document.getElementById('m-timeline');
        tl.innerHTML = '';
        
        if(history.length === 0) {
            tl.innerHTML = '<div class="text-muted text-center py-3">Ch∆∞a c√≥ l·ªãch s·ª≠ s·ª≠a ch·ªØa.</div>';
        } else {
            history.forEach(h => {
                const date = new Date(h[1]).toLocaleDateString('vi-VN');
                tl.innerHTML += `
                    <div class="timeline-item">
                        <small class="text-muted fw-bold">${date}</small>
                        <h6 class="mb-1">${h[2]}</h6>
                        <p class="mb-0 text-secondary small">${h[4]}</p>
                        <span class="badge bg-light text-dark border mt-1">${h[5]}</span>
                    </div>
                `;
            });
        }
        
        // Store ID for quick report
        document.getElementById('modalDevice').dataset.deviceId = d.id;
        
        new bootstrap.Modal(document.getElementById('modalDevice')).show();
    }

    function reportFromModal() {
        // Close modal and switch to report tab
        const id = document.getElementById('modalDevice').dataset.deviceId;
        const d = devices.find(x => x.id == id);
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalDevice'));
        modal.hide();
        
        switchTab('maintenance');
        // Pre-fill
        const select = document.getElementById('rpt-device');
        select.value = d.name;
        document.getElementById('rpt-content').focus();
    }

    function populateDropdowns() {
        const depts = [...new Set(devices.map(d => d.dept))].sort();
        const selFilter = document.getElementById('filter-dept');
        selFilter.innerHTML = '<option value="">T·∫•t c·∫£ khoa</option>';
        depts.forEach(d => selFilter.add(new Option(d, d)));

        const selReport = document.getElementById('rpt-device');
        selReport.innerHTML = '';
        devices.forEach(d => selReport.add(new Option(`${d.name} [${d.dept}]`, d.name)));
    }

    function filterTable() {
        const txt = document.getElementById('search-input').value.toLowerCase();
        const dept = document.getElementById('filter-dept').value;
        const rows = document.querySelectorAll('#inventory-body tr');
        
        let visibleCount = 0;
        rows.forEach((row, idx) => {
            const d = devices[idx]; // Assuming 1-1 mapping matches index
            const matchTxt = d.name.toLowerCase().includes(txt) || d.model.toLowerCase().includes(txt) || d.serial.toLowerCase().includes(txt);
            const matchDept = !dept || d.dept === dept;
            
            if (matchTxt && matchDept) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
    }

    async function handleReportSubmit(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        const originalText = btn.innerText;
        btn.disabled = true; btn.innerText = "ƒêang g·ª≠i...";
        
        const payload = {
            action: 'add_repair',
            device: document.getElementById('rpt-device').value,
            type: document.getElementById('rpt-type').value,
            content: document.getElementById('rpt-content').value,
            by: document.getElementById('rpt-by').value
        };
        
        try {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            }).then(r => r.json());
            
            if(res.status === 'success') {
                alert("‚úÖ G·ª≠i y√™u c·∫ßu th√†nh c√¥ng!");
                e.target.reset();
                fetchData(); // Refresh to update ticket list and device status
            } else {
                alert("‚õî L·ªói: " + res.message);
            }
        } catch(err) {
            alert("L·ªói m·∫°ng!");
        } finally {
            btn.disabled = false; btn.innerText = originalText;
        }
    }

    function formatDateForCal(str) {
        if(!str) return new Date();
        const p = str.split('/');
        // Assuming Input Format MM/dd/yyyy based on previous prompt context
        // If your sheet is dd/MM/yyyy, change to `${p[2]}-${p[1]}-${p[0]}`
        return p.length === 3 ? `${p[2]}-${p[0]}-${p[1]}` : new Date();
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
