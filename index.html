<!DOCTYPE html>
<html lang="vi">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Quáº£n lÃ½ Khoa DÆ°á»£c</title>
Â  Â  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
Â  Â  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
Â  Â  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
Â  Â  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
Â  Â  
Â  Â  <style>
Â  Â  Â  Â  :root { --primary-color: #0f9d58; --bg-color: #f0f2f5; }
Â  Â  Â  Â  body { background-color: var(--bg-color); font-family: 'Segoe UI', sans-serif; font-size: 14px; }
Â  Â  Â  Â  .nav-pills .nav-link.active { background-color: var(--primary-color); color: white; box-shadow: 0 4px 6px rgba(15, 157, 88, 0.3); }
Â  Â  Â  Â  .nav-pills .nav-link { color: #555; font-weight: 600; cursor: pointer;}
Â  Â  Â  Â  .card-custom { border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-radius: 12px; background: white; }
Â  Â  Â  Â  .badge-status { font-size: 0.85rem; padding: 6px 12px; border-radius: 20px; }
Â  Â  Â  Â  
Â  Â  Â  Â  /* --- MÃ€U TRáº NG THÃI ÄÃƒ CHá»ˆNH Sá»¬A --- */
Â  Â  Â  Â  .bg-todo { background-color: #3f51b5; color: white; } /* MÃ u Indigo (Xanh tÃ­m) Ä‘áº¹p hÆ¡n cho Todo */
Â  Â  Â  Â  .bg-doing { background-color: #ffc107; color: #333; } 
Â  Â  Â  Â  .bg-done { background-color: #198754; color: white; }
Â  Â  Â  Â  .bg-overdue { background-color: #dc3545; color: white; }
Â  Â  Â  Â  /* ----------------------------------- */
Â  Â  Â  Â  
Â  Â  Â  Â  .disabled-control { pointer-events: none; opacity: 0.6; filter: grayscale(100%); cursor: not-allowed; }
Â  Â  Â  Â  .admin-only, .logged-only { display: none !important; }
Â  Â  Â  Â  .range-slider { width: 100%; cursor: pointer; height: 8px; accent-color: var(--primary-color); }
Â  Â  Â  Â  .btn-action { font-size: 0.8rem; font-weight: 500; padding: 4px 8px; width: 100%; text-align: left; margin-bottom: 4px; border-radius: 4px; border: none; transition: 0.2s; }
Â  Â  Â  Â  .btn-email { background-color: #fff3cd; color: #856404; } .btn-email:hover { background-color: #ffeeba; }
Â  Â  Â  Â  .deadline-extended { color: #6f42c1; font-weight: bold; }
Â  Â  Â  Â  .deadline-original { text-decoration: line-through; color: #999; font-size: 0.85em; display: block; }
Â  Â  Â  Â  .dropdown-menu-custom { max-height: 300px; overflow-y: auto; width: 100%; padding: 0; }
Â  Â  Â  Â  .person-item { padding: 8px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; }
Â  Â  Â  Â  .person-item:hover { background-color: #f8f9fa; }
Â  Â  Â  Â  .person-item input { margin-right: 10px; transform: scale(1.2); cursor: pointer; }
Â  Â  Â  Â  .person-item label { cursor: pointer; flex-grow: 1; margin: 0; }
Â  Â  Â  Â  #hiddenAssigneeSelect { display: none; }
Â  Â  Â  Â  
Â  Â  Â  Â  .type-routine { border-left: 4px solid #adb5bd; }
Â  Â  Â  Â  .type-deadline { border-left: 4px solid #0d6efd; background-color: #f8f9fa; }
Â  Â  Â  Â  .type-overdue { border-left: 4px solid #dc3545; background-color: #fff5f5; }
Â  Â  Â  Â  
Â  Â  Â  Â  .group-tag { font-size: 0.75rem; background: #e9ecef; padding: 2px 6px; border-radius: 4px; color: #495057; display: inline-block; margin-top: 2px; font-weight: bold;}
Â  Â  </style>
</head>
<body>

<div class="container-fluid px-4 py-4">
Â  Â  <div class="d-flex justify-content-between align-items-center mb-4">
Â  Â  Â  Â  <h3 class="text-success fw-bold m-0">ğŸ¥ QUáº¢N LÃ KHOA DÆ¯á»¢C</h3>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <span id="userDisplay" class="me-2 fw-bold text-primary"></span>
Â  Â  Â  Â  Â  Â  <button class="btn btn-outline-secondary btn-sm d-none me-1" id="btnChangePin" onclick="showChangePinModal()">ğŸ” Äá»•i PIN</button>
Â  Â  Â  Â  Â  Â  <button class="btn btn-outline-dark btn-sm" id="btnLogin" onclick="showLoginModal()">ğŸ‘¤ ÄÄƒng nháº­p</button>
Â  Â  Â  Â  Â  Â  <button class="btn btn-outline-danger btn-sm d-none" id="btnLogout" onclick="logout()">ğŸšª ThoÃ¡t</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <ul class="nav nav-pills nav-fill mb-4 bg-white p-2 rounded shadow-sm" id="pills-tab" role="tablist">
Â  Â  Â  Â  <li class="nav-item admin-only"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-input">ğŸ“ Giao Viá»‡c</button></li>
Â  Â  Â  Â  <li class="nav-item admin-only"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-compliance">âš–ï¸ Ná»™i Quy</button></li>
Â  Â  Â  Â  <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-list" onclick="loadTaskList()">ğŸ“‹ Danh SÃ¡ch</button></li>
Â  Â  Â  Â  <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-report" onclick="loadDashboard()">ğŸ“Š BÃ¡o CÃ¡o</button></li>
Â  Â  </ul>

Â  Â  <div class="tab-content">
Â  Â  Â  Â  <!-- TAB GIAO VIá»†C -->
Â  Â  Â  Â  <div class="tab-pane fade" id="pills-input">
Â  Â  Â  Â  Â  Â  <div class="container" style="max-width: 900px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card card-custom p-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="taskForm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-3"><label class="fw-bold">TÃªn cÃ´ng viá»‡c</label><input type="text" class="form-control" name="taskName" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="fw-bold">NgÆ°á»i thá»±c hiá»‡n</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select name="assignee" id="hiddenAssigneeSelect" multiple></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dropdown">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-outline-secondary w-100 text-start d-flex justify-content-between" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="selectedText">-- Chá»n nhÃ¢n sá»± --</span><span class="badge bg-success rounded-pill" id="selectedCount">0</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dropdown-menu dropdown-menu-custom shadow" id="checkboxContainer"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="fw-bold">Thuá»™c Tá»•/Bá»™ pháº­n</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select class="form-select" name="group" id="groupSelect"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="fw-bold">PhÃ¢n loáº¡i cÃ´ng viá»‡c</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select class="form-select" name="taskType" id="taskTypeSelect" onchange="toggleDeadline()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="ThÆ°á»ng quy" selected>ğŸŸ¦ CÃ´ng viá»‡c ThÆ°á»ng quy</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="CÃ³ háº¡n">ğŸŸ¥ CÃ´ng viá»‡c CÃ³ háº¡n (Deadline)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3"><label class="fw-bold">Má»©c Ä‘á»™ Æ¯u tiÃªn</label><select class="form-select" name="priority"><option value="P1">ğŸ”´ Cao</option><option value="P2" selected>ğŸŸ¡ Trung bÃ¬nh</option><option value="P3">ğŸŸ¢ Tháº¥p</option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3"><label class="fw-bold">Deadline (Háº¡n chÃ³t)</label><input type="date" class="form-control" name="deadline" id="deadlineInput"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-3"><textarea class="form-control" name="notes" rows="2" placeholder="Ghi chÃº chi tiáº¿t..."></textarea></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn btn-success w-100 fw-bold" id="submitBtn">ğŸ’¾ LÆ¯U CÃ”NG VIá»†C</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- TAB DANH SÃCH -->
Â  Â  Â  Â  <div class="tab-pane fade show active" id="pills-list">
Â  Â  Â  Â  Â  Â  <div class="card card-custom p-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="row g-2 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-3"><select id="filterGroup" class="form-select form-select-sm" onchange="renderTable()"></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-3"><select id="filterAssignee" class="form-select form-select-sm" onchange="renderTable()"></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Cáº¬P NHáº¬T FILTER TRáº NG THÃI -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="filterStatus" class="form-select form-select-sm" onchange="renderTable()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">TT: Táº¥t cáº£</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Todo">Todo (ThÆ°á»ng quy)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- ÄÃ£ bá» má»¥c ChÆ°a lÃ m -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Doing">Doing (Äang lÃ m)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Done">Done (Xong)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Háº¿t háº¡n">Háº¿t háº¡n</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-2"><input type="text" id="filterText" class="form-control form-control-sm" placeholder="TÃ¬m tÃªn..." onkeyup="renderTable()"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-2 d-flex gap-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-warning btn-sm fw-bold w-100 admin-only" onclick="triggerBulkEmail()" title="Gá»­i mail cho táº¥t cáº£ viá»‡c chÆ°a xong">ğŸ“§ Gá»­i</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary btn-sm w-50" onclick="loadTaskList()">ğŸ”„</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-responsive">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="table table-hover align-middle border">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="table-success">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th width="30%">CÃ´ng viá»‡c / Tá»•</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th width="20%">Tiáº¿n Ä‘á»™</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th width="15%">NgÆ°á»i lÃ m</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th width="10%">Deadline</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th width="10%">Tráº¡ng thÃ¡i</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th width="10%">HÃ nh Ä‘á»™ng</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="taskTableBody"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- TAB Ná»˜I QUY -->
Â  Â  Â  Â  <div class="tab-pane fade" id="pills-compliance">
Â  Â  Â  Â  Â  Â  Â <div class="row g-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card card-custom p-3 h-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h5 class="text-danger fw-bold text-center">âš–ï¸ Ghi nháº­n Vi pháº¡m/Khen</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="complianceForm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-2"><label class="fw-bold small">NhÃ¢n viÃªn</label><select class="form-select" name="person" id="compliancePerson" required></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-2"><label class="fw-bold small">Loáº¡i</label><select class="form-select" name="type" required><option value="Vi pháº¡m">âš ï¸ Vi pháº¡m</option><option value="Khen thÆ°á»Ÿng">ğŸ† Khen thÆ°á»Ÿng</option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-2"><label class="fw-bold small">Ná»™i dung</label><textarea class="form-control" name="fault" rows="3" required></textarea></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-3"><label class="fw-bold small">Ghi chÃº</label><input type="text" class="form-control" name="note"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn btn-danger w-100" id="btnCompliance">LÆ°u ghi nháº­n</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card card-custom p-3 h-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="d-flex justify-content-between mb-3"><h5 class="fw-bold text-secondary">ğŸ“œ Lá»‹ch sá»­</h5><button class="btn btn-sm btn-outline-secondary" onclick="loadCompliance()">ğŸ”„ Táº£i láº¡i</button></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-responsive"><table class="table table-sm table-striped"><thead class="table-light"><tr><th>NgÃ y</th><th>NhÃ¢n viÃªn</th><th>Loáº¡i</th><th>Ná»™i dung</th><th>Ghi chÃº</th></tr></thead><tbody id="complianceBody"></tbody></table></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- TAB BÃO CÃO -->
Â  Â  Â  Â  <div class="tab-pane fade" id="pills-report">
Â  Â  Â  Â  Â  Â  <div class="card card-custom p-3 mb-4 bg-light">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="row align-items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-2 fw-bold text-success">ğŸ“… CHá»ŒN THÃNG:</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="month" id="reportMonthSelect" class="form-control" onchange="updateReport()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-7 text-end">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-success fw-bold" onclick="exportExcelReport()">ğŸ“¥ Xuáº¥t File Excel</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â <div class="row g-4 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6"><div class="card card-custom p-3 h-100"><h6 class="text-center fw-bold text-secondary">ğŸ“Š TÃ¬nh tráº¡ng cÃ´ng viá»‡c</h6><div id="piechart_task" style="height:300px;"></div></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6"><div class="card card-custom p-3 h-100"><h6 class="text-center fw-bold text-secondary">ğŸ“ˆ Sá»‘ lÆ°á»£ng cÃ´ng viá»‡c (Chi tiáº¿t)</h6><div id="barchart_task" style="height:300px;"></div></div></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="row g-4 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6"><div class="card card-custom p-3 h-100"><h6 class="text-center fw-bold text-danger">âš ï¸ Vi pháº¡m</h6><div id="columnchart_violation" style="height:300px;"></div></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6"><div class="card card-custom p-3 h-100"><h6 class="text-center fw-bold text-warning">ğŸ† Khen thÆ°á»Ÿng</h6><div id="columnchart_reward" style="height:300px;"></div></div></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card card-custom p-4"><h5 class="text-success fw-bold mb-3">ğŸ“… Lá»ŠCH Tá»”NG Há»¢P</h5><div id="calendar"></div></div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<!-- Login & Pin Modals -->
<div class="modal fade" id="loginModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ğŸ” ÄÄƒng nháº­p</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
Â  Â  <div class="mb-3"><label class="fw-bold">TÃªn Ä‘Äƒng nháº­p:</label><input type="text" id="loginUsername" class="form-control" placeholder="VÃ­ dá»¥: thuongpb"></div>
Â  Â  <div class="mb-3"><label class="fw-bold">MÃ£ PIN:</label><input type="password" id="loginPin" class="form-control" placeholder="Nháº­p PIN..."></div>
</div><div class="modal-footer"><button type="button" class="btn btn-primary w-100" onclick="performLogin()">ÄÄƒng nháº­p</button></div></div></div></div>
<div class="modal fade" id="changePinModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ğŸ” Äá»•i MÃ£ PIN</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label class="fw-bold">PIN CÅ©:</label><input type="password" id="oldPin" class="form-control"></div><div class="mb-3"><label class="fw-bold">PIN Má»›i:</label><input type="password" id="newPin" class="form-control"></div><div class="mb-3"><label class="fw-bold">Nháº­p láº¡i PIN Má»›i:</label><input type="password" id="confirmPin" class="form-control"></div></div><div class="modal-footer"><button type="button" class="btn btn-success w-100" onclick="submitChangePin()">XÃ¡c nháº­n Äá»•i</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
Â  Â  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxK5MlsJWyH67Ckuwa48uctGPV-otNqg8a3vgyttWm6gIg_eInJt-JpUtB1VtF_Ah40Pw/exec"; 
Â  Â  let globalData = [], globalCompliance = [], currentUser = null;

Â  Â  const STAFF_GROUPS = {
        "ThÃ nh viÃªn": ["Nguyá»…n Thá»‹ HÆ°Æ¡ng Giang - TrÆ°á»Ÿng Khoa", "Tráº§n Thá»‹ Huyá»n Trang - PhÃ³ Khoa", "Pháº¡m BÃ¡ ThÆ°Æ¡ng", "LÃª Thá»‹ Thanh NhÃ n", "Chu ÄÃ i Trang", "Nguyá»…n Duy Tiáº¿n", "Nguyá»…n Thá»‹ Háº±ng", "Kiá»u Máº¡nh ToÃ n", "Äá»— Thá»‹ Nháº­t Lá»‡", "Nguyá»…n Thá»‹ Thu HÃ ", "HÃ  Thá»‹ Tháº£o", "Nguyá»…n Tuáº¥n ThÃ nh", "VÅ© Thá»‹ Há»“ng Háº¡nh", "HÃ  Thu Trang", "ÄoÃ n Thá»‹ Mai HÆ°Æ¡ng", "Triá»‡u Thá»‹ Vá»µ"]
    };

Â  Â  initUI(); loadTaskList(); checkSession();

Â  Â  function initUI() { 
Â  Â  Â  Â  initCheckboxes(); 
Â  Â  Â  Â  initSingleSelect('compliancePerson');
Â  Â  Â  Â  initGroupSelect(); 
Â  Â  Â  Â  toggleDeadline(); 
Â  Â  Â  Â  
Â  Â  Â  Â  // Set máº·c Ä‘á»‹nh thÃ¡ng hiá»‡n táº¡i cho bÃ¡o cÃ¡o
Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  const monthStr = now.toISOString().slice(0, 7); // YYYY-MM
Â  Â  Â  Â  document.getElementById('reportMonthSelect').value = monthStr;
Â  Â  }
Â  Â  
Â  Â  // --- CÃC HÃ€M GIAO DIá»†N CÅ¨ ---
Â  Â  function toggleDeadline() {
Â  Â  Â  Â  const typeSelect = document.getElementById('taskTypeSelect');
Â  Â  Â  Â  const dlInput = document.getElementById('deadlineInput');
Â  Â  Â  Â  if (typeSelect.value === 'ThÆ°á»ng quy') {
Â  Â  Â  Â  Â  Â  dlInput.value = ''; dlInput.disabled = true; dlInput.required = false; 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  dlInput.disabled = false; dlInput.required = true; 
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function initGroupSelect() {
    const GROUP_LIST = [
        "Tá»• kho",
        "Tá»• DÆ°á»£c lÃ¢m sÃ ng",
        "Tá»• Trang thiáº¿t bá»‹",
        "Tá»• Thá»‘ng kÃª vÃ  nghiá»‡p vá»¥ dÆ°á»£c",
        "Tá»• Truyá»n thÃ´ng",
        "Tá»• 5S",
        "Tá»• Cung á»©ng"
    ];

    const s = document.getElementById('groupSelect');
    s.innerHTML = '<option value="">-- Chá»n tá»• --</option>';
    GROUP_LIST.forEach(group => {
        s.innerHTML += `<option value="${group}">${group}</option>`;
    });

    const f = document.getElementById('filterGroup');
    f.innerHTML = '<option value="">ğŸ¢ Tá»•: Táº¥t cáº£</option>';
    GROUP_LIST.forEach(group => {
        f.innerHTML += `<option value="${group}">${group}</option>`;
    });
}

Â  Â  function initCheckboxes() { 
Â  Â  Â  Â  const c = document.getElementById('checkboxContainer'); const h = document.getElementById('hiddenAssigneeSelect');
Â  Â  Â  Â  const t = document.getElementById('selectedText'); const n = document.getElementById('selectedCount');
Â  Â  Â  Â  c.innerHTML = ""; h.innerHTML = ""; 
Â  Â  Â  Â  let allStaff = [];
Â  Â  Â  Â  for(const [group, staffList] of Object.entries(STAFF_GROUPS)){ allStaff.push(...staffList); }
Â  Â  Â  Â  allStaff = [...new Set(allStaff)];
Â  Â  Â  Â  allStaff.forEach((name, i) => {
Â  Â  Â  Â  Â  Â  h.add(new Option(name, name));
Â  Â  Â  Â  Â  Â  const d = document.createElement('div'); d.className = 'person-item'; d.onclick = function(e) { e.stopPropagation(); }
Â  Â  Â  Â  Â  Â  d.innerHTML = `<input class="form-check-input" type="checkbox" value="${name}" id="chk${i}"><label for="chk${i}">${name}</label>`;
Â  Â  Â  Â  Â  Â  c.appendChild(d);
Â  Â  Â  Â  Â  Â  d.querySelector('input').addEventListener('change', (e) => { h.options[i].selected = e.target.checked; updateDisplay(h, t, n); });
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- LOGIN ---
Â  Â  function showLoginModal() { new bootstrap.Modal(document.getElementById('loginModal')).show(); }
Â  Â  function performLogin() {
Â  Â  Â  Â  const username = document.getElementById('loginUsername').value, pin = document.getElementById('loginPin').value;
Â  Â  Â  Â  if(!username || !pin) return alert("Thiáº¿u thÃ´ng tin!");
Â  Â  Â  Â  fetch(SCRIPT_URL + "?action=login", { method: 'POST', body: JSON.stringify({ username, pin }) }).then(r => r.json()).then(res => {
Â  Â  Â  Â  Â  Â  if(res.status === 'success') {
Â  Â  Â  Â  Â  Â  Â  Â  currentUser = { username: res.username, name: res.name, role: res.role };
Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem('user', JSON.stringify(currentUser));
Â  Â  Â  Â  Â  Â  Â  Â  applyLoginState(); bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
Â  Â  Â  Â  Â  Â  Â  Â  alert(`ğŸ”“ Xin chÃ o ${res.name}`); loadTaskList();
Â  Â  Â  Â  Â  Â  } else alert("â›” " + res.message);
Â  Â  Â  Â  });
Â  Â  }
Â  Â  function logout() { sessionStorage.removeItem('user'); currentUser = null; applyLoginState(); location.reload(); }
Â  Â  function checkSession() { const saved = sessionStorage.getItem('user'); if(saved) { currentUser = JSON.parse(saved); applyLoginState(); } }
Â  Â  function applyLoginState() {
Â  Â  Â  Â  const isLoggedIn = !!currentUser;
Â  Â  Â  Â  document.getElementById('btnLogin').classList.toggle('d-none', isLoggedIn);
Â  Â  Â  Â  document.getElementById('btnLogout').classList.toggle('d-none', !isLoggedIn);
Â  Â  Â  Â  document.getElementById('btnChangePin').classList.toggle('d-none', !isLoggedIn);
Â  Â  Â  Â  document.getElementById('userDisplay').innerText = isLoggedIn ? `ğŸ‘¤ ${currentUser.name}` : "";
Â  Â  Â  Â  const isAdmin = currentUser && currentUser.role === 'Admin';
Â  Â  Â  Â  document.querySelectorAll('.admin-only').forEach(el => el.style.setProperty("display", isAdmin ? "block" : "none", "important"));
Â  Â  }
Â  Â  function showChangePinModal() { new bootstrap.Modal(document.getElementById('changePinModal')).show(); }
Â  Â  function submitChangePin() {
Â  Â  Â  Â  const oldPin = document.getElementById('oldPin').value, newPin = document.getElementById('newPin').value, confirmPin = document.getElementById('confirmPin').value;
Â  Â  Â  Â  if(!oldPin || !newPin) return alert("Thiáº¿u thÃ´ng tin!"); if(newPin !== confirmPin) return alert("PIN má»›i khÃ´ng khá»›p!");
Â  Â  Â  Â  fetch(SCRIPT_URL + "?action=change_pin", { method: 'POST', body: JSON.stringify({ username: currentUser.username, oldPin, newPin }) }).then(r => r.json()).then(res => { alert(res.message); if(res.status === 'success') { bootstrap.Modal.getInstance(document.getElementById('changePinModal')).hide(); logout(); } });
Â  Â  }

Â  Â  // --- RENDER TABLE & FILTER ---
Â  Â  function renderTable() {
Â  Â  Â  Â  const tb = document.getElementById('taskTableBody'); tb.innerHTML="";
Â  Â  Â  Â  const fG = document.getElementById('filterGroup').value.toLowerCase().trim();
Â  Â  Â  Â  const fN = document.getElementById('filterAssignee').value.toLowerCase().trim();
Â  Â  Â  Â  const fS = document.getElementById('filterStatus').value; // Bá»™ lá»c Tráº¡ng thÃ¡i
Â  Â  Â  Â  const fT = document.getElementById('filterText').value.toLowerCase().trim();
Â  Â  Â  Â  const today = new Date(); today.setHours(0,0,0,0);
Â  Â  Â  Â  
Â  Â  Â  Â  let flt = globalData.filter(r => {
Â  Â  Â  Â  Â  Â  // Láº¥y dá»¯ liá»‡u cÆ¡ báº£n
Â  Â  Â  Â  Â  Â  let group = String(r[11] || "").toLowerCase();
Â  Â  Â  Â  Â  Â  let as = String(r[7]).toLowerCase(), stDB = String(r[2]).trim(), nm = String(r[1]).toLowerCase();
Â  Â  Â  Â  Â  Â  let type = String(r[10] || "ThÆ°á»ng quy");
Â  Â  Â  Â  Â  Â  let dlRaw = r[9] || r[4];
Â  Â  Â  Â  Â  Â  let dlDate = dlRaw ? new Date(dlRaw) : null;
Â  Â  Â  Â  Â  Â  let isOverdue = (stDB !== 'Done' && dlDate && dlDate < today);

Â  Â  Â  Â  Â  Â  // TÃNH TOÃN TRáº NG THÃI HIá»‚N THá»Š (Äá»ƒ lá»c)
Â  Â  Â  Â  Â  Â  let calculatedStatus = "";
Â  Â  Â  Â  Â  Â  if (stDB === 'Done') calculatedStatus = "Done";
Â  Â  Â  Â  Â  Â  else if (isOverdue) calculatedStatus = "Háº¿t háº¡n";
Â  Â  Â  Â  Â  Â  else if (stDB === 'Doing') calculatedStatus = "Doing";
Â  Â  Â  Â  Â  Â  else calculatedStatus = "Todo"; // Má»i tráº¡ng thÃ¡i chÆ°a lÃ m Ä‘á»u lÃ  Todo

Â  Â  Â  Â  Â  Â  // Logic lá»c
Â  Â  Â  Â  Â  Â  return (fG === "" || group.includes(fG)) && 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â (fN === "" || as.includes(fN)) && 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â (fS === "" || calculatedStatus === fS) && // Lá»c theo tráº¡ng thÃ¡i tÃ­nh toÃ¡n
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â (fT === "" || nm.includes(fT));
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  // Sáº¯p xáº¿p
Â  Â  Â  Â  flt.sort((a, b) => {
Â  Â  Â  Â  Â  Â  const grpA = (a[11] || "").toLowerCase(), grpB = (b[11] || "").toLowerCase(); if (grpA < grpB) return -1; if (grpA > grpB) return 1;
Â  Â  Â  Â  Â  Â  const statusA = String(a[2]).trim(), statusB = String(b[2]).trim();
Â  Â  Â  Â  Â  Â  const doneA = statusA === 'Done', doneB = statusB === 'Done'; if (doneA && !doneB) return 1; if (!doneA && doneB) return -1;
Â  Â  Â  Â  Â  Â  const dateA = new Date(a[9] || a[4] || '9999-12-31'); const dateB = new Date(b[9] || b[4] || '9999-12-31'); return dateA - dateB;
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  flt.forEach(r => {
Â  Â  Â  Â  Â  Â  let id = r[0], name = r[1], status = String(r[2]).trim(), assignee = r[7];
Â  Â  Â  Â  Â  Â  let type = r[10] || "ThÆ°á»ng quy", group = r[11] || ""; 
Â  Â  Â  Â  Â  Â  let dlRaw = r[9] || r[4], dlDisp = dlRaw ? new Date(dlRaw).toLocaleDateString('vi-VN') : '';
Â  Â  Â  Â  Â  Â  let prog = parseProgress(r[8]);
Â  Â  Â  Â  Â  Â  let isOwner = currentUser && (currentUser.role === 'Admin' || assignee.includes(currentUser.name));
Â  Â  Â  Â  Â  Â  let disableClass = isOwner ? "" : "disabled-control";

Â  Â  Â  Â  Â  Â  let typeClass = type === 'CÃ³ háº¡n' ? 'type-deadline' : 'type-routine';
Â  Â  Â  Â  Â  Â  let groupBadge = group ? `<div class="group-tag">ğŸ¢ ${group}</div>` : '';

Â  Â  Â  Â  Â  Â  let isOverdue = false, dlDate = dlRaw ? new Date(dlRaw) : null;
Â  Â  Â  Â  Â  Â  if (dlDate && dlDate < today && status !== 'Done') {
Â  Â  Â  Â  Â  Â  Â  Â  isOverdue = true; 
Â  Â  Â  Â  Â  Â  Â  Â  typeClass = 'type-overdue'; 
Â  Â  Â  Â  Â  Â  Â  Â  if (currentUser && currentUser.role !== 'Admin') disableClass = "disabled-control"; 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- LOGIC HIá»‚N THá»Š LABEL VÃ€ BADGE ---
Â  Â  Â  Â  Â  Â  let displayStatus = "";
Â  Â  Â  Â  Â  Â  let badgeCls = "";
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (status === 'Done') {
Â  Â  Â  Â  Â  Â  Â  Â  displayStatus = "Done"; badgeCls = "bg-done";
Â  Â  Â  Â  Â  Â  } else if (isOverdue) {
Â  Â  Â  Â  Â  Â  Â  Â  displayStatus = "Háº¿t háº¡n"; badgeCls = "bg-overdue";
Â  Â  Â  Â  Â  Â  } else if (status === 'Doing') {
Â  Â  Â  Â  Â  Â  Â  Â  displayStatus = "Doing"; badgeCls = "bg-doing";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Táº¥t cáº£ chÆ°a lÃ m Ä‘á»u hiá»‡n Todo
Â  Â  Â  Â  Â  Â  Â  Â  displayStatus = "Todo"; badgeCls = "bg-todo";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Badge loáº¡i cÃ´ng viá»‡c (nhá» cáº¡nh tÃªn)
Â  Â  Â  Â  Â  Â  let typeBadge = type === 'CÃ³ háº¡n' ? '<span class="badge bg-primary ms-1">ğŸ”¥ Deadline</span>' : '<span class="badge bg-secondary ms-1">ThÆ°á»ng quy</span>';
Â  Â  Â  Â  Â  Â  if (isOverdue) typeBadge = '<span class="badge bg-danger ms-1">â›” QuÃ¡ háº¡n</span>';

Â  Â  Â  Â  Â  Â  let dlHtml = dlDisp;
Â  Â  Â  Â  Â  Â  if (r[9] && r[9] !== r[4]) dlHtml = `<span class="deadline-original">${new Date(r[4]).toLocaleDateString('vi-VN')}</span><span class="deadline-extended"> Gia háº¡n: ${dlDisp}</span>`;

Â  Â  Â  Â  Â  Â  let slider = status === 'Done' ? `<div class="progress" style="height:20px"><div class="progress-bar bg-success" style="width:100%">100%</div></div>` : `<div class="d-flex align-items-center ${disableClass}"><input type="range" class="range-slider me-2" min="0" max="100" step="10" value="${prog}" onchange="updateProgress('${id}',this.value)"><span class="badge bg-secondary" id="val-${id}" style="min-width:35px">${prog}%</span></div>`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  let btnDone = status !== 'Done' ? `<button class="btn btn-sm btn-outline-success mb-1 w-100 ${disableClass}" onclick="markDone('${id}')">âœ… Xong</button>` : '';
Â  Â  Â  Â  Â  Â  let btnMail = status !== 'Done' ? `<button class="btn btn-action btn-email ${disableClass}" onclick="sendEmailBackend('${id}','${name}','${assignee}','${dlRaw}')">ğŸ“§ Nháº¯c</button>` : '';
Â  Â  Â  Â  Â  Â  let assigneeHtml = isOverdue ? `<small class="fw-bold text-danger">ğŸ”’ ${assignee}</small>` : `<small class="fw-bold">${assignee}</small>`;

Â  Â  Â  Â  Â  Â  tb.innerHTML += `<tr class="${typeClass}"><td><span class="fw-bold text-primary">${name}</span>${typeBadge}<br>${groupBadge}<br><small class="text-muted">${r[5] || ''}</small></td><td>${slider}</td><td>${assigneeHtml}</td><td class="${checkOverdue(dlRaw, status)}">${dlHtml}</td><td><span class="badge badge-status ${badgeCls}">${displayStatus}</span></td><td>${btnDone}${btnMail}</td></tr>`;
Â  Â  Â  Â  });
Â  Â  }
Â  Â  
Â  Â  function checkOverdue(d, s) { if (!d || s === 'Done') return ""; return new Date(d) < new Date() ? "text-danger fw-bold" : ""; }
Â  Â  function updateProgress(id, v) { if(!currentUser) return alert("Vui lÃ²ng Ä‘Äƒng nháº­p!"); document.getElementById(`val-${id}`).innerText=v+'%'; fetch(SCRIPT_URL+"?action=update_progress",{method:'POST',body:JSON.stringify({id:id,progress:v, user_fullname: currentUser.name, role: currentUser.role})}).then(r=>r.json()).then(res=>{if(res.status==='error'){alert(res.message); loadTaskList();} else if(v==100)loadTaskList()}); }
Â  Â  function markDone(id) { if(!currentUser) return alert("Vui lÃ²ng Ä‘Äƒng nháº­p!"); if(confirm('Xong chÆ°a?')) fetch(SCRIPT_URL+"?action=update",{method:'POST',body:JSON.stringify({id:id, user_fullname: currentUser.name, role: currentUser.role})}).then(r=>r.json()).then(res=>{alert(res.message);loadTaskList()}); }
Â  Â  function parseProgress(val) { if(!val)return 0; let s=String(val).replace(/^'/,'').replace('%','').trim(); let n=parseFloat(s); return isNaN(n)?0:(n<=1&&n>0&&s.includes('.')?Math.round(n*100):Math.round(n)); }
Â  Â  function loadTaskList() { document.getElementById('taskTableBody').innerHTML='<tr><td colspan="7" class="text-center py-5"><div class="spinner-border text-success"></div></td></tr>'; fetch(SCRIPT_URL).then(r=>r.json()).then(res=>{ globalData=res.data; populateFilter(); renderTable(); }); }
Â  Â  function populateFilter() { const s = document.getElementById('filterAssignee'); s.innerHTML = '<option value="">NV: Táº¥t cáº£</option>'; let a = []; globalData.forEach(r => a.push(...String(r[7]).split(',').map(v => v.trim()).filter(v => v))); [...new Set(a)].sort().forEach(n => s.innerHTML += `<option value="${n}">${n}</option>`); }
Â  Â  function sendEmailBackend(id,t,p,d){ if(!confirm(`Gá»­i mail cho ${p}?`))return; let dl=d?new Date(d).toLocaleDateString('vi-VN'):'Som nhat'; const btn=event.target; const txt=btn.innerText; btn.innerText="â³..."; btn.disabled=true; fetch(SCRIPT_URL+"?action=send_email_manual",{method:'POST',body:JSON.stringify({taskName:t,assignee:p,deadline:dl})}).then(r=>r.json()).then(res=>{alert(res.message)}).finally(()=>{btn.innerText=txt;btn.disabled=false}); }
Â  Â  function triggerBulkEmail() { if(!currentUser || currentUser.role !== 'Admin') return alert("â›” Chá»‰ Admin!"); const pending=globalData.filter(r=>String(r[2]).trim()!=='Done'); if(pending.length===0) return alert("KhÃ´ng cÃ³ viá»‡c cáº§n gá»­i!"); if(!confirm(`Gá»­i mail cho ${pending.length} viá»‡c?`))return; const btn=event.target;const t=btn.innerText;btn.innerText="â³...";btn.disabled=true; fetch(SCRIPT_URL+"?action=send_bulk_email",{method:'POST',body:JSON.stringify({taskIds:pending.map(r=>r[0]),sender:currentUser.name})}).then(r=>r.json()).then(res=>alert(res.message)).finally(()=>{btn.innerText=t;btn.disabled=false}); }

Â  Â  document.getElementById('taskForm').addEventListener('submit', e => { e.preventDefault(); if(!currentUser||currentUser.role!=='Admin'){alert("â›” Chá»‰ Admin!");return;} const btn=document.getElementById('submitBtn'); btn.disabled=true; const d=Object.fromEntries(new FormData(e.target).entries()); d.assignee=Array.from(document.getElementById('hiddenAssigneeSelect').selectedOptions).map(o=>o.value).join(', '); d.role=currentUser.role; fetch(SCRIPT_URL+"?action=add",{method:'POST',body:JSON.stringify(d)}).then(r=>r.json()).then(res=>{ alert(res.message); if(res.status==='success'){e.target.reset(); document.querySelectorAll('#checkboxContainer input').forEach(c=>c.checked=false); updateDisplay(document.getElementById('hiddenAssigneeSelect'),document.getElementById('selectedText'),document.getElementById('selectedCount')); document.querySelector('[data-bs-target="#pills-list"]').click(); loadTaskList();} }).finally(()=>{btn.disabled=false;}); });
Â  Â  document.getElementById('complianceForm').addEventListener('submit', e => { e.preventDefault(); if(!currentUser||currentUser.role!=='Admin'){alert("â›” Chá»‰ Admin!");return;} const btn=document.getElementById('btnCompliance'); btn.disabled=true; const d=Object.fromEntries(new FormData(e.target).entries()); d.role=currentUser.role; fetch(SCRIPT_URL+"?action=add_compliance",{method:'POST',body:JSON.stringify(d)}).then(r=>r.json()).then(res=>{ alert(res.message); if(res.status==='success'){e.target.reset(); loadCompliance();} }).finally(()=>{btn.disabled=false;}); });
Â  Â  function updateDisplay(s,t,c){let cnt=0,nm=[]; Array.from(s.options).forEach(o=>{if(o.selected){cnt++;nm.push(o.value)}});c.innerText=cnt;t.innerText=cnt===0?"-- Chá»n nhÃ¢n sá»± --":(cnt<=2?nm.join(", "):`ÄÃ£ chá»n ${cnt} ngÆ°á»i`);}
Â  Â  function initSingleSelect(elId) { const s=document.getElementById(elId); s.innerHTML='<option value="">-- Chá»n --</option>'; for(const[g,ppl] of Object.entries(STAFF_GROUPS)){ const o=document.createElement('optgroup'); o.label=g; ppl.forEach(n=>o.innerHTML+=`<option value="${n}">${n}</option>`); s.appendChild(o); } }
Â  Â  
Â  Â  // --- LOAD Dá»® LIá»†U ---
Â  Â  function loadCompliance(){
Â  Â  Â  Â  const tb=document.getElementById('complianceBody');tb.innerHTML='<tr><td colspan="5" class="text-center">Loading...</td></tr>'; 
Â  Â  Â  Â  fetch(SCRIPT_URL+"?action=read_compliance").then(r=>r.json()).then(res=>{ 
Â  Â  Â  Â  Â  Â  globalCompliance = res.data || []; 
Â  Â  Â  Â  Â  Â  tb.innerHTML=""; 
Â  Â  Â  Â  Â  Â  if(!res.data||!res.data.length){tb.innerHTML='<tr><td colspan="5" class="text-center text-muted">Trá»‘ng</td></tr>';return;} 
Â  Â  Â  Â  Â  Â  res.data.reverse().forEach(r=>{ 
Â  Â  Â  Â  Â  Â  Â  Â  let h=r.length>=6,t=h?r[3]:(r[3].includes("Khen")?"Khen thÆ°á»Ÿng":"Vi pháº¡m"),c=h?r[4]:r[3],n=h?r[5]:r[4],b=t.includes("Khen")?'<span class="badge bg-warning text-dark">ğŸ† Khen</span>':'<span class="badge bg-danger">âš ï¸ Vi pháº¡m</span>'; 
Â  Â  Â  Â  Â  Â  Â  Â  tb.innerHTML+=`<tr><td>${new Date(r[1]).toLocaleDateString('vi-VN')}</td><td class="fw-bold">${r[2]}</td><td>${b}</td><td>${c}</td><td>${n||''}</td></tr>`; 
Â  Â  Â  Â  Â  Â  }); 
Â  Â  Â  Â  }); 
Â  Â  }
Â  Â  
Â  Â  google.charts.load('current',{'packages':['corechart','bar']});
Â  Â  
Â  Â  function loadDashboard() { 
Â  Â  Â  Â  if(SCRIPT_URL.includes("DÃN_LINK")) return; 
Â  Â  Â  Â  Promise.all([
Â  Â  Â  Â  Â  Â  fetch(SCRIPT_URL).then(r=>r.json()), 
Â  Â  Â  Â  Â  Â  fetch(SCRIPT_URL+"?action=read_compliance").then(r=>r.json())
Â  Â  Â  Â  ]).then(([taskRes, compRes]) => { 
Â  Â  Â  Â  Â  Â  globalData = taskRes.data || [];
Â  Â  Â  Â  Â  Â  globalCompliance = compRes.data || [];
Â  Â  Â  Â  Â  Â  updateReport(); 
Â  Â  Â  Â  }); 
Â  Â  }
Â  Â  
Â  Â  function updateReport() {
Â  Â  Â  Â  const monthStr = document.getElementById('reportMonthSelect').value; // YYYY-MM
Â  Â  Â  Â  if (!monthStr) return;

Â  Â  Â  Â  const [year, month] = monthStr.split('-').map(Number);
Â  Â  Â  Â  const startOfMonth = new Date(year, month - 1, 1);
Â  Â  Â  Â  const endOfMonth = new Date(year, month, 0, 23, 59, 59);

Â  Â  Â  Â  const filteredTasks = globalData.filter(r => {
Â  Â  Â  Â  Â  Â  const created = new Date(r[6]);
Â  Â  Â  Â  Â  Â  let deadline = r[9] ? new Date(r[9]) : (r[4] ? new Date(r[4]) : new Date());
Â  Â  Â  Â  Â  Â  return created <= endOfMonth && deadline >= startOfMonth;
Â  Â  Â  Â  });

Â  Â  Â  Â  const filteredCompliance = globalCompliance.filter(r => {
Â  Â  Â  Â  Â  Â  const date = new Date(r[1]);
Â  Â  Â  Â  Â  Â  return date >= startOfMonth && date <= endOfMonth;
Â  Â  Â  Â  });

Â  Â  Â  Â  drawCharts(filteredTasks, filteredCompliance);
Â  Â  Â  Â  renderCal(filteredTasks, filteredCompliance); 
Â  Â  }

Â  Â  function exportExcelReport() {
Â  Â  Â  Â  const monthStr = document.getElementById('reportMonthSelect').value;
Â  Â  Â  Â  const [year, month] = monthStr.split('-').map(Number);
Â  Â  Â  Â  const startOfMonth = new Date(year, month - 1, 1);
Â  Â  Â  Â  const endOfMonth = new Date(year, month, 0, 23, 59, 59);

Â  Â  Â  Â  const taskData = globalData
Â  Â  Â  Â  Â  Â  .filter(r => {
Â  Â  Â  Â  Â  Â  Â  Â  const created = new Date(r[6]);
Â  Â  Â  Â  Â  Â  Â  Â  let deadline = r[9] ? new Date(r[9]) : (r[4] ? new Date(r[4]) : new Date());
Â  Â  Â  Â  Â  Â  Â  Â  return created <= endOfMonth && deadline >= startOfMonth;
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .map(r => ({
Â  Â  Â  Â  Â  Â  Â  Â  "TÃªn cÃ´ng viá»‡c": r[1],
Â  Â  Â  Â  Â  Â  Â  Â  "Tá»•": r[11] || "",
Â  Â  Â  Â  Â  Â  Â  Â  "NgÆ°á»i thá»±c hiá»‡n": r[7],
Â  Â  Â  Â  Â  Â  Â  Â  "Tráº¡ng thÃ¡i": r[2],
Â  Â  Â  Â  Â  Â  Â  Â  "NgÃ y táº¡o": new Date(r[6]).toLocaleDateString('vi-VN'),
Â  Â  Â  Â  Â  Â  Â  Â  "Deadline": r[9] ? new Date(r[9]).toLocaleDateString('vi-VN') : (r[4] ? new Date(r[4]).toLocaleDateString('vi-VN') : ""),
Â  Â  Â  Â  Â  Â  Â  Â  "Loáº¡i": r[10] || "",
Â  Â  Â  Â  Â  Â  Â  Â  "Tiáº¿n Ä‘á»™": r[8] + "%",
Â  Â  Â  Â  Â  Â  Â  Â  "Ghi chÃº": r[5]
Â  Â  Â  Â  Â  Â  }));

Â  Â  Â  Â  const complianceData = globalCompliance
Â  Â  Â  Â  Â  Â  .filter(r => {
Â  Â  Â  Â  Â  Â  Â  Â  const date = new Date(r[1]);
Â  Â  Â  Â  Â  Â  Â  Â  return date >= startOfMonth && date <= endOfMonth;
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .map(r => {
Â  Â  Â  Â  Â  Â  Â  Â  let isNewFormat = r.length >= 6;
Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "NgÃ y": new Date(r[1]).toLocaleDateString('vi-VN'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "NhÃ¢n viÃªn": r[2],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "Loáº¡i": isNewFormat ? r[3] : (r[3].includes("Khen") ? "Khen thÆ°á»Ÿng" : "Vi pháº¡m"),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "Ná»™i dung": isNewFormat ? r[4] : r[3],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "Ghi chÃº": isNewFormat ? r[5] : r[4]
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  const wb = XLSX.utils.book_new();
Â  Â  Â  Â  if (taskData.length > 0) {
Â  Â  Â  Â  Â  Â  const wsTasks = XLSX.utils.json_to_sheet(taskData);
Â  Â  Â  Â  Â  Â  const wscols = Object.keys(taskData[0]).map(k => ({wch: 20}));
Â  Â  Â  Â  Â  Â  wsTasks['!cols'] = wscols;
Â  Â  Â  Â  Â  Â  XLSX.utils.book_append_sheet(wb, wsTasks, "CÃ´ng viá»‡c ThÃ¡ng " + month);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([{"ThÃ´ng bÃ¡o": "KhÃ´ng cÃ³ dá»¯ liá»‡u"}]), "CÃ´ng viá»‡c");
Â  Â  Â  Â  }

Â  Â  Â  Â  if (complianceData.length > 0) {
Â  Â  Â  Â  Â  Â  const wsComp = XLSX.utils.json_to_sheet(complianceData);
Â  Â  Â  Â  Â  Â  XLSX.utils.book_append_sheet(wb, wsComp, "Ná»™i quy ThÃ¡ng " + month);
Â  Â  Â  Â  }

Â  Â  Â  Â  XLSX.writeFile(wb, `BÃ¡o_CÃ¡o_Khoa_DÆ°á»£c_${monthStr}.xlsx`);
Â  Â  }
Â  Â  
Â  Â  function drawCharts(t,c) { 
Â  Â  Â  Â  var stats = {'Done': 0, 'Normal': 0, 'Overdue': 0, 'Extended': 0};
Â  Â  Â  Â  var p = {}; 
Â  Â  Â  Â  var today = new Date(); today.setHours(0,0,0,0);

Â  Â  Â  Â  t.forEach(r => {
Â  Â  Â  Â  Â  Â  let status = String(r[2]).trim();
Â  Â  Â  Â  Â  Â  let dlRaw = r[9] || r[4];
Â  Â  Â  Â  Â  Â  let dl = dlRaw ? new Date(dlRaw) : null;
Â  Â  Â  Â  Â  Â  let isExtended = r[9] && r[9] !== r[4];
Â  Â  Â  Â  Â  Â  let isOverdue = (status !== 'Done' && dl && dl < today);

Â  Â  Â  Â  Â  Â  String(r[7]).split(',').forEach(n=>{ 
Â  Â  Â  Â  Â  Â  Â  Â  n=n.trim(); 
Â  Â  Â  Â  Â  Â  Â  Â  if(n){ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!p[n]) p[n] = { done: 0, overdue: 0, normal: 0 };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (status === 'Done') p[n].done++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (isOverdue) p[n].overdue++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else p[n].normal++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (status === 'Done') stats.Done++;
Â  Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  Â  Â  if (isOverdue) stats.Overdue++;
Â  Â  Â  Â  Â  Â  Â  Â  else if (isExtended) stats.Extended++;
Â  Â  Â  Â  Â  Â  Â  Â  else stats.Normal++;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }); 
Â  Â  Â  Â  
Â  Â  Â  Â  var pieData = google.visualization.arrayToDataTable([
Â  Â  Â  Â  Â  Â  ['Tráº¡ng thÃ¡i', 'Sá»‘ lÆ°á»£ng'],
Â  Â  Â  Â  Â  Â  ['HoÃ n thÃ nh', stats.Done],
Â  Â  Â  Â  Â  Â  ['Äang lÃ m', stats.Normal],
Â  Â  Â  Â  Â  Â  ['Gia háº¡n', stats.Extended],
Â  Â  Â  Â  Â  Â  ['QuÃ¡ háº¡n', stats.Overdue]
Â  Â  Â  Â  ]);

Â  Â  Â  Â  new google.visualization.PieChart(document.getElementById('piechart_task')).draw(pieData, {
Â  Â  Â  Â  Â  Â  colors: ['#198754', '#0d6efd', '#6f42c1', '#dc3545'], 
Â  Â  Â  Â  Â  Â  is3D: true, legend: 'bottom', chartArea: {width:'90%', height:'80%'}
Â  Â  Â  Â  }); 
Â  Â  Â  Â  
Â  Â  Â  Â  var arr = [['NhÃ¢n viÃªn', 'HoÃ n thÃ nh', 'Äang lÃ m', 'QuÃ¡ háº¡n']];
Â  Â  Â  Â  Object.keys(p).sort().forEach(k => { arr.push([k, p[k].done, p[k].normal, p[k].overdue]); });

Â  Â  Â  Â  new google.visualization.ColumnChart(document.getElementById('barchart_task')).draw(google.visualization.arrayToDataTable(arr),{
Â  Â  Â  Â  Â  Â  isStacked: true, colors: ['#198754', '#0d6efd', '#dc3545'], legend: { position: 'bottom' }, chartArea: {width:'85%', height:'70%'}
Â  Â  Â  Â  }); 
Â  Â  Â  Â  
Â  Â  Â  Â  var pc={}; c.forEach(r=>{let n=r[2],h=r.length>=6,tp=h?r[3]:(r[3].includes("Khen")?"Khen":"Vi pháº¡m");if(!pc[n])pc[n]=0;if(!tp.includes("Khen"))pc[n]++;}); 
Â  Â  Â  Â  var ac=[['NV','Vi pháº¡m',{role:"style"}]]; Object.keys(pc).sort().forEach(k=>{if(pc[k]>0)ac.push([k,pc[k],'#dc3545']);}); 
Â  Â  Â  Â  if(ac.length>1) new google.visualization.ColumnChart(document.getElementById('columnchart_violation')).draw(google.visualization.arrayToDataTable(ac),{legend:'none',chartArea:{width:'85%',height:'70%'}}); else document.getElementById('columnchart_violation').innerHTML="<div class='text-center mt-5 text-muted'>ChÆ°a cÃ³ vi pháº¡m!</div>";
Â  Â  Â  Â  
Â  Â  Â  Â  var pr={}; c.forEach(r=>{let n=r[2],h=r.length>=6,tp=h?r[3]:(r[3].includes("Khen")?"Khen":"Vi pháº¡m");if(!pr[n])pr[n]=0;if(tp.includes("Khen"))pr[n]++;}); 
Â  Â  Â  Â  var ar=[['NV','Khen thÆ°á»Ÿng',{role:"style"}]]; Object.keys(pr).sort().forEach(k=>{if(pr[k]>0)ar.push([k,pr[k],'#ffc107']);}); 
Â  Â  Â  Â  if(ar.length>1) new google.visualization.ColumnChart(document.getElementById('columnchart_reward')).draw(google.visualization.arrayToDataTable(ar),{legend:'none',chartArea:{width:'85%',height:'70%'}}); else document.getElementById('columnchart_reward').innerHTML="<div class='text-center mt-5 text-muted'>ChÆ°a cÃ³ khen thÆ°á»Ÿng!</div>";
Â  Â  }
Â  Â  
Â  Â  function renderCal(t,c) { var ev=[]; t.forEach(r=>{let d=r[9]||r[4];if(!d)return;ev.push({title:`${r[1]} (${r[7]})`,start:new Date(d).toISOString().split('T')[0],color:r[2]==='Done'?'#198754':(r[2]==='Todo'?'#dc3545':'#ffc107'),textColor:r[2]==='Doing'?'black':'white',extendedProps:{description:r[5]||'KhÃ´ng cÃ³ ghi chÃº'}});}); c.forEach(r=>{if(!r[1])return;let h=r.length>=6,tp=h?r[3]:(r[3].includes("Khen")?"Khen":"Vi pháº¡m"),ib=tp.includes("Khen"),ct=h?r[4]:r[3];ev.push({title:ib?`ğŸ† ${r[2]}`:`âš ï¸ ${r[2]}`,start:new Date(r[1]).toISOString().split('T')[0],color:ib?'#fd7e14':'#212529',textColor:'white',description:ct});}); var cal=new FullCalendar.Calendar(document.getElementById('calendar'),{initialView:'dayGridMonth',locale:'vi',height:'85vh',headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,listMonth'},events:ev,eventClick:function(i){alert('ğŸ“Œ '+i.event.title+'\nâ„¹ï¸ '+(i.event.extendedProps.description||'Deadline'));}}); cal.render(); setTimeout(()=>cal.updateSize(),200); }
</script>
</body>
</html>
